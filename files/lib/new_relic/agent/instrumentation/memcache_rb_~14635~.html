<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>memcache.rb.~14635~</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" href="../../../../../css/reset.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="../../../../../css/main.css" type="text/css" media="screen" />
    <script src="../../../../../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../../../../js/jquery-effect.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../../../../js/main.js" type="text/javascript" charset="utf-8"></script>
</head>

<body>     
    <div class="banner">
        <h1>
            memcache.rb.~14635~
        </h1>
        <ul class="files">
            <li>lib/new_relic/agent/instrumentation/memcache.rb.~14635~</li>
            <li>Last modified: Fri Feb 26 09:05:10 -0800 2010</li>
        </ul>
    </div>

    <div id="bodyContent">
        <div id="content">
    
    <div class="description">
        <p>
# NOTE there are multiple implementations of the MemCache client in Ruby, #
each with slightly different API&#8217;s and semantics. # See: # <a
href="http://www.deveiate.org/code/Ruby-MemCache">www.deveiate.org/code/Ruby-MemCache</a>/
(Gem: Ruby-MemCache) # <a
href="http://seattlerb.rubyforge.org/memcache-client">seattlerb.rubyforge.org/memcache-client</a>/
(Gem: memcache-client) unless <a
href="../../../../../classes/NewRelic/Control.html#M001016">NewRelic::Control.instance</a>[&#8216;disable_memcache_instrumentation&#8217;]
</p>
<pre>
  MemCache.class_eval do

    # This is in the memcache-client implementation and has never existed in Ruby-MemCache
    if self.method_defined? :cache_get

      if self.method_defined? :get
        def get_with_newrelic_trace(key, raw=false)
          if NewRelic::Agent::Instrumentation::MetricFrame.recording_web_transaction?
            self.class.trace_execution_scoped(['MemCache/read', 'MemCache/allWeb']) do
              get_without_newrelic_trace(key, raw)
            end
          else
            self.class.trace_execution_scoped(['MemCache/read', 'MemCache/allOther']) do
              get_without_newrelic_trace(key, raw)
            end
          end
        end

        alias get_without_newrelic_trace get
        alias get get_with_newrelic_trace
      end

      if self.method_defined? :get_multi
        def get_multi_with_newrelic_trace(*keys)
          if NewRelic::Agent::Instrumentation::MetricFrame.recording_web_transaction?
            self.class.trace_execution_scoped(['MemCache/read', 'MemCache/allWeb']) do
              get_without_newrelic_trace(keys)
            end
          else
            self.class.trace_execution_scoped(['MemCache/read', 'MemCache/allOther']) do
              get_without_newrelic_trace(keys)
            end
          end
        end

        alias get_multi_without_newrelic_trace get_multi
        alias get_multi get_multi_with_newrelic_trace
      end

      if self.method_defined? :add
        def add_with_newrelic_trace(key, value, expiry=0, raw=false)
          if NewRelic::Agent::Instrumentation::MetricFrame.recording_web_transaction?
            self.class.trace_execution_scoped(['MemCache/write', 'MemCache/allWeb']) do
              add_without_newrelic_trace(key, value, expiry, raw)
            end
          else
            self.class.trace_execution_scoped(['MemCache/write', 'MemCache/allOther']) do
              add_without_newrelic_trace(key, value, expiry, raw)
            end
          end
        end

        alias add_without_newrelic_trace add
        alias add add_with_newrelic_trace
      end

      if self.method_defined? :decr
        def decr_with_newrelic_trace(key, amount=1)
          if NewRelic::Agent::Instrumentation::MetricFrame.recording_web_transaction?
            self.class.trace_execution_scoped(['MemCache/write', 'MemCache/allWeb']) do
              decr_without_newrelic_trace(key, amount)
            end
          else
            self.class.trace_execution_scoped(['MemCache/write', 'MemCache/allOther']) do
              decr_without_newrelic_trace(key, amount)
            end
          end
        end

        alias decr_without_newrelic_trace decr
        alias decr decr_with_newrelic_trace
      end

      if self.method_defined? :delete
        def delete_with_newrelic_trace(key, expiry=0)
          if NewRelic::Agent::Instrumentation::MetricFrame.recording_web_transaction?
            self.class.trace_execution_scoped(['MemCache/write', 'MemCache/allWeb']) do
              delete_without_newrelic_trace(key, expiry)
            end
          else
            self.class.trace_execution_scoped(['MemCache/write', 'MemCache/allOther']) do
              delete_without_newrelic_trace(key, expiry)
            end
          end
        end

        alias delete_without_newrelic_trace delete
        alias delete delete_with_newrelic_trace
      end

      if self.method_defined? :incr
        def incr_with_newrelic_trace(key, amount=1)
          if NewRelic::Agent::Instrumentation::MetricFrame.recording_web_transaction?
            self.class.trace_execution_scoped(['MemCache/write', 'MemCache/allWeb']) do
              incr_without_newrelic_trace(key, amount)
            end
          else
            self.class.trace_execution_scoped(['MemCache/write', 'MemCache/allOther']) do
              incr_without_newrelic_trace(key, amount)
            end
          end
        end

        alias incr_without_newrelic_trace incr
        alias incr incr_with_newrelic_trace
      end

      if self.method_defined? :set
        def set_with_newrelic_trace(key, value, expiry=0, raw=false)
          if NewRelic::Agent::Instrumentation::MetricFrame.recording_web_transaction?
            self.class.trace_execution_scoped(['MemCache/write', 'MemCache/allWeb']) do
              set_without_newrelic_trace(key, value, expiry, raw)
            end
          else
            self.class.trace_execution_scoped(['MemCache/write', 'MemCache/allOther']) do
              set_without_newrelic_trace(key, value, expiry, raw)
            end
          end
        end

        alias set_without_newrelic_trace set
        alias set set_with_newrelic_trace
      end

    else  # Ruby-MemCache
      add_method_tracer :get, 'MemCache/read' if self.method_defined? :get
      add_method_tracer :get_multi, 'MemCache/read' if self.method_defined? :get_multi
      %w[set add incr decr delete].each do | method |
        add_method_tracer method, 'MemCache/write' if self.method_defined? method
      end
    end
  end if defined? MemCache

  # Support for libmemcached through Evan Weaver's memcached wrapper
  # http://blog.evanweaver.com/files/doc/fauna/memcached/classes/Memcached.html
  Memcached.class_eval do
    add_method_tracer :get, 'MemCache/read' if self.method_defined? :get
  %w[set add increment decrement delete replace append prepend cas].each do | method |
      add_method_tracer method, &quot;MemCache/write&quot; if self.method_defined? method
    end
  end if defined? Memcached
</pre>
<p>
end
</p>

    </div>
    

    

    
    

    
    

    

    

    

    

    

    
</div>
    </div>
  </body>
</html>