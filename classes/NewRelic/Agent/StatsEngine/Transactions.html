<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Module: NewRelic::Agent::StatsEngine::Transactions</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href="../../../.././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Module</strong></td>
          <td class="class-name-in-header">NewRelic::Agent::StatsEngine::Transactions</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../../../../files/lib/new_relic/agent/stats_engine/transactions_rb.html">
                lib/new_relic/agent/stats_engine/transactions.rb
                </a>
        <br />
            </td>
        </tr>

        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">



   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000220">end_transaction</a>&nbsp;&nbsp;
      <a href="#M000216">peek_scope</a>&nbsp;&nbsp;
      <a href="#M000215">pop_scope</a>&nbsp;&nbsp;
      <a href="#M000214">push_scope</a>&nbsp;&nbsp;
      <a href="#M000213">remove_transaction_sampler</a>&nbsp;&nbsp;
      <a href="#M000218">scope_name</a>&nbsp;&nbsp;
      <a href="#M000217">scope_name=</a>&nbsp;&nbsp;
      <a href="#M000219">start_transaction</a>&nbsp;&nbsp;
      <a href="#M000212">transaction_sampler=</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->

    <div id="section">





      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000220" class="method-detail">
        <a name="M000220"></a>

        <div class="method-heading">
          <a href="#M000220" class="method-signature">
          <span class="method-name">end_transaction</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Try to clean up gracefully, otherwise we leave things hanging around on
thread locals. If it looks like a transaction is still in progress, then
maybe this is an inner transaction and is ignored.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000220-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000220-source">
<pre>
<span class="ruby-comment cmt"># File lib/new_relic/agent/stats_engine/transactions.rb, line 102</span>
      <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">end_transaction</span>
        <span class="ruby-identifier">stack</span> = <span class="ruby-identifier">scope_stack</span>
        
        <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">stack</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">stack</span>.<span class="ruby-identifier">empty?</span>
          <span class="ruby-constant">Thread</span><span class="ruby-operator">::</span><span class="ruby-identifier">current</span>[<span class="ruby-identifier">:newrelic_scope_stack</span>] = <span class="ruby-keyword kw">nil</span>
          <span class="ruby-constant">Thread</span><span class="ruby-operator">::</span><span class="ruby-identifier">current</span>[<span class="ruby-identifier">:newrelic_scope_name</span>] = <span class="ruby-keyword kw">nil</span>
        <span class="ruby-keyword kw">end</span>
      <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000216" class="method-detail">
        <a name="M000216"></a>

        <div class="method-heading">
          <a href="#M000216" class="method-signature">
          <span class="method-name">peek_scope</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000216-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000216-source">
<pre>
<span class="ruby-comment cmt"># File lib/new_relic/agent/stats_engine/transactions.rb, line 72</span>
      <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">peek_scope</span>
        <span class="ruby-identifier">scope_stack</span>.<span class="ruby-identifier">last</span>
      <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000215" class="method-detail">
        <a name="M000215"></a>

        <div class="method-heading">
          <a href="#M000215" class="method-signature">
          <span class="method-name">pop_scope</span><span class="method-args">(expected_scope, duration, time=Time.now.to_f)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000215-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000215-source">
<pre>
<span class="ruby-comment cmt"># File lib/new_relic/agent/stats_engine/transactions.rb, line 55</span>
      <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">pop_scope</span>(<span class="ruby-identifier">expected_scope</span>, <span class="ruby-identifier">duration</span>, <span class="ruby-identifier">time</span>=<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">to_f</span>)
        <span class="ruby-identifier">capture_gc_time</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">collecting_gc?</span>
        <span class="ruby-identifier">stack</span> = <span class="ruby-identifier">scope_stack</span>
        <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">stack</span>.<span class="ruby-identifier">pop</span>
        <span class="ruby-identifier">fail</span> <span class="ruby-node">&quot;unbalanced pop from blame stack, got #{scope ? scope.name : 'nil'}, expected #{expected_scope ? expected_scope.name : 'nil'}&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">scope</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">expected_scope</span>
        
        <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">stack</span>.<span class="ruby-identifier">empty?</span> 
          <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">deduct_call_time_from_parent</span>
            <span class="ruby-identifier">stack</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">children_time</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">duration</span>
          <span class="ruby-keyword kw">else</span>
            <span class="ruby-identifier">stack</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">children_time</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">children_time</span>
          <span class="ruby-keyword kw">end</span>
        <span class="ruby-keyword kw">end</span>
        <span class="ruby-ivar">@transaction_sampler</span>.<span class="ruby-identifier">notice_pop_scope</span>(<span class="ruby-identifier">scope</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">time</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@transaction_sampler</span>
        <span class="ruby-identifier">scope</span>
      <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000214" class="method-detail">
        <a name="M000214"></a>

        <div class="method-heading">
          <a href="#M000214" class="method-signature">
          <span class="method-name">push_scope</span><span class="method-args">(metric, time = Time.now.to_f, deduct_call_time_from_parent = true)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000214-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000214-source">
<pre>
<span class="ruby-comment cmt"># File lib/new_relic/agent/stats_engine/transactions.rb, line 37</span>
      <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">push_scope</span>(<span class="ruby-identifier">metric</span>, <span class="ruby-identifier">time</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">to_f</span>, <span class="ruby-identifier">deduct_call_time_from_parent</span> = <span class="ruby-keyword kw">true</span>)
        
        <span class="ruby-identifier">stack</span> = <span class="ruby-identifier">scope_stack</span>
        <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">collecting_gc?</span>
          <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">stack</span>.<span class="ruby-identifier">empty?</span>
            <span class="ruby-comment cmt"># reset the gc time so we only include gc time spent during this call</span>
            <span class="ruby-ivar">@last_gc_timestamp</span> = <span class="ruby-constant">GC</span>.<span class="ruby-identifier">time</span>
            <span class="ruby-ivar">@last_gc_count</span> = <span class="ruby-constant">GC</span>.<span class="ruby-identifier">collections</span>
          <span class="ruby-keyword kw">else</span>
            <span class="ruby-identifier">capture_gc_time</span>
          <span class="ruby-keyword kw">end</span>
        <span class="ruby-keyword kw">end</span>
        <span class="ruby-ivar">@transaction_sampler</span>.<span class="ruby-identifier">notice_push_scope</span> <span class="ruby-identifier">metric</span>, <span class="ruby-identifier">time</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@transaction_sampler</span>
        <span class="ruby-identifier">scope</span> = <span class="ruby-constant">ScopeStackElement</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">metric</span>, <span class="ruby-identifier">deduct_call_time_from_parent</span>)
        <span class="ruby-identifier">stack</span>.<span class="ruby-identifier">push</span> <span class="ruby-identifier">scope</span>
        <span class="ruby-identifier">scope</span>
      <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000213" class="method-detail">
        <a name="M000213"></a>

        <div class="method-heading">
          <a href="#M000213" class="method-signature">
          <span class="method-name">remove_transaction_sampler</span><span class="method-args">(l)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000213-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000213-source">
<pre>
<span class="ruby-comment cmt"># File lib/new_relic/agent/stats_engine/transactions.rb, line 33</span>
      <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">remove_transaction_sampler</span>(<span class="ruby-identifier">l</span>)
        <span class="ruby-ivar">@transaction_sampler</span> = <span class="ruby-keyword kw">nil</span>
      <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000218" class="method-detail">
        <a name="M000218"></a>

        <div class="method-heading">
          <a href="#M000218" class="method-signature">
          <span class="method-name">scope_name</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000218-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000218-source">
<pre>
<span class="ruby-comment cmt"># File lib/new_relic/agent/stats_engine/transactions.rb, line 88</span>
      <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">scope_name</span>
        <span class="ruby-constant">Thread</span><span class="ruby-operator">::</span><span class="ruby-identifier">current</span>[<span class="ruby-identifier">:newrelic_scope_name</span>]
      <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000217" class="method-detail">
        <a name="M000217"></a>

        <div class="method-heading">
          <a href="#M000217" class="method-signature">
          <span class="method-name">scope_name=</span><span class="method-args">(transaction)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
set the name of the transaction for the current thread, which will be used
to define the scope of all traced methods called on this thread until the
scope stack is empty.
</p>
<p>
currently the transaction name is the name of the controller action that is
invoked via the dispatcher, but conceivably we could use other transaction
names in the future if the traced application does more than service http
request via controller actions
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000217-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000217-source">
<pre>
<span class="ruby-comment cmt"># File lib/new_relic/agent/stats_engine/transactions.rb, line 84</span>
      <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">scope_name=</span>(<span class="ruby-identifier">transaction</span>)
        <span class="ruby-constant">Thread</span><span class="ruby-operator">::</span><span class="ruby-identifier">current</span>[<span class="ruby-identifier">:newrelic_scope_name</span>] = <span class="ruby-identifier">transaction</span>
      <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000219" class="method-detail">
        <a name="M000219"></a>

        <div class="method-heading">
          <a href="#M000219" class="method-signature">
          <span class="method-name">start_transaction</span><span class="method-args">(name = nil)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Start a new transaction, unless one is already in progress
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000219-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000219-source">
<pre>
<span class="ruby-comment cmt"># File lib/new_relic/agent/stats_engine/transactions.rb, line 93</span>
      <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">start_transaction</span>(<span class="ruby-identifier">name</span> = <span class="ruby-keyword kw">nil</span>)
        <span class="ruby-constant">Thread</span><span class="ruby-operator">::</span><span class="ruby-identifier">current</span>[<span class="ruby-identifier">:newrelic_scope_stack</span>] <span class="ruby-operator">||=</span> []
        <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">scope_name</span> = <span class="ruby-identifier">name</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">name</span>
      <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000212" class="method-detail">
        <a name="M000212"></a>

        <div class="method-heading">
          <a href="#M000212" class="method-signature">
          <span class="method-name">transaction_sampler=</span><span class="method-args">(sampler)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000212-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000212-source">
<pre>
<span class="ruby-comment cmt"># File lib/new_relic/agent/stats_engine/transactions.rb, line 28</span>
      <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">transaction_sampler=</span> <span class="ruby-identifier">sampler</span>
        <span class="ruby-identifier">fail</span> <span class="ruby-value str">&quot;Can't add a scope listener midflight in a transaction&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">scope_stack</span>.<span class="ruby-identifier">any?</span>
        <span class="ruby-ivar">@transaction_sampler</span> = <span class="ruby-identifier">sampler</span>
      <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>