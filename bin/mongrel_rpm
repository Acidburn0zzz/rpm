#!/usr/bin/env ruby
require 'rubygems'
require 'rack'
require 'rack/handler/mongrel'
require 'optparse'

port = 3000
logging = true
appname = nil
license_key = nil

OptionParser.new do |opts|
  opts.banner = "Usage: #{ARGV[0]} [options] app_name"
  opts.on("-p", "--port=port", Integer, "default: #{port}") { | port | }
  opts.on("--[no-]logging", "turn off request logging" ) { | logging | }
  opts.on("--license=rpm_license_key", "override license key" ) { | license_key | }
  opts.separator ""
  opts.separator "app_name is the name of the application where the metrics will be stored"
  opts.separator ""
  # The rackup file references this var
  appname = opts.parse!(ARGV.clone).first
end

ru_file = File.expand_path(File.join(File.dirname(__FILE__), "..", "lib", "new_relic", "rack", "newrelic.ru"))
rackup_code = File.read ru_file
builder = Rack::Builder.new { eval rackup_code, binding, ru_file }

options = { :Host => '127.0.0.1', :Port => port }
Rack::Handler::Mongrel.run(builder.to_app, options) do | server |
   NewRelic::Control.instance.log! "Started Mongrel listening for '#{NewRelic::Control.instance.app_name}' data at #{server.host}:#{server.port}" 
end

