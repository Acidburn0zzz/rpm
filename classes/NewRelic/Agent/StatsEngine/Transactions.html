<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Module: NewRelic::Agent::StatsEngine::Transactions</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href="../../../.././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Module</strong></td>
          <td class="class-name-in-header">NewRelic::Agent::StatsEngine::Transactions</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../../../../files/lib/new_relic/agent/stats_engine/transactions_rb.html">
                lib/new_relic/agent/stats_engine/transactions.rb
                </a>
        <br />
            </td>
        </tr>

        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">



   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000188">end_transaction</a>&nbsp;&nbsp;
      <a href="#M000184">peek_scope</a>&nbsp;&nbsp;
      <a href="#M000183">pop_scope</a>&nbsp;&nbsp;
      <a href="#M000182">push_scope</a>&nbsp;&nbsp;
      <a href="#M000181">remove_transaction_sampler</a>&nbsp;&nbsp;
      <a href="#M000187">start_transaction</a>&nbsp;&nbsp;
      <a href="#M000186">transaction_name</a>&nbsp;&nbsp;
      <a href="#M000185">transaction_name=</a>&nbsp;&nbsp;
      <a href="#M000180">transaction_sampler=</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->

    <div id="section">


    <div id="constants-list">
      <h3 class="section-bar">Constants</h3>

      <div class="name-list">
        <table summary="Constants">
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">EPSILON</td>
          <td>=</td>
          <td class="context-item-value">100</td>
          <td width="3em">&nbsp;</td>
          <td class="context-item-desc">
smallest recordable amount of GC time. We ignore anything smaller than this
since it&#8216;s under our reporting thresholds

</td>
        </tr>
        </table>
      </div>
    </div>



      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000188" class="method-detail">
        <a name="M000188"></a>

        <div class="method-heading">
          <a href="#M000188" class="method-signature">
          <span class="method-name">end_transaction</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Try to clean up gracefully, otherwise we leave things hanging around on
thread locals
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000188-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000188-source">
<pre>
     <span class="ruby-comment cmt"># File lib/new_relic/agent/stats_engine/transactions.rb, line 103</span>
103:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">end_transaction</span>
104:         <span class="ruby-identifier">stack</span> = <span class="ruby-identifier">scope_stack</span>
105:         
106:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">stack</span>
107:           <span class="ruby-ivar">@transaction_sampler</span>.<span class="ruby-identifier">notice_scope_empty</span>(<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@transaction_sampler</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">stack</span>.<span class="ruby-identifier">empty?</span> 
108:           <span class="ruby-constant">Thread</span><span class="ruby-operator">::</span><span class="ruby-identifier">current</span>[<span class="ruby-identifier">:newrelic_scope_stack</span>] = <span class="ruby-keyword kw">nil</span>
109:         <span class="ruby-keyword kw">end</span>
110:         
111:         <span class="ruby-constant">Thread</span><span class="ruby-operator">::</span><span class="ruby-identifier">current</span>[<span class="ruby-identifier">:newrelic_transaction_name</span>] = <span class="ruby-keyword kw">nil</span>
112:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000184" class="method-detail">
        <a name="M000184"></a>

        <div class="method-heading">
          <a href="#M000184" class="method-signature">
          <span class="method-name">peek_scope</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000184-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000184-source">
<pre>
    <span class="ruby-comment cmt"># File lib/new_relic/agent/stats_engine/transactions.rb, line 77</span>
77:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">peek_scope</span>
78:         <span class="ruby-identifier">scope_stack</span>.<span class="ruby-identifier">last</span>
79:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000183" class="method-detail">
        <a name="M000183"></a>

        <div class="method-heading">
          <a href="#M000183" class="method-signature">
          <span class="method-name">pop_scope</span><span class="method-args">(expected_scope, duration, time=Time.now.to_f)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000183-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000183-source">
<pre>
    <span class="ruby-comment cmt"># File lib/new_relic/agent/stats_engine/transactions.rb, line 55</span>
55:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">pop_scope</span>(<span class="ruby-identifier">expected_scope</span>, <span class="ruby-identifier">duration</span>, <span class="ruby-identifier">time</span>=<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">to_f</span>)
56:         <span class="ruby-identifier">capture_gc_time</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">collecting_gc?</span>
57:         <span class="ruby-identifier">stack</span> = <span class="ruby-identifier">scope_stack</span>
58:         <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">stack</span>.<span class="ruby-identifier">pop</span>
59:         
60:         <span class="ruby-identifier">fail</span> <span class="ruby-node">&quot;unbalanced pop from blame stack: #{scope.name} != #{expected_scope.name}&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">scope</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">expected_scope</span>
61:         
62:         <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">stack</span>.<span class="ruby-identifier">empty?</span> 
63:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">deduct_call_time_from_parent</span>
64:             <span class="ruby-identifier">stack</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">children_time</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">duration</span>
65:           <span class="ruby-keyword kw">else</span>
66:             <span class="ruby-identifier">stack</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">children_time</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">children_time</span>
67:           <span class="ruby-keyword kw">end</span>
68:         <span class="ruby-keyword kw">end</span>
69:         
70:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@transaction_sampler</span>
71:           <span class="ruby-ivar">@transaction_sampler</span>.<span class="ruby-identifier">notice_pop_scope</span>(<span class="ruby-identifier">scope</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">time</span>)
72:           <span class="ruby-ivar">@transaction_sampler</span>.<span class="ruby-identifier">notice_scope_empty</span>(<span class="ruby-identifier">time</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">stack</span>.<span class="ruby-identifier">empty?</span> 
73:         <span class="ruby-keyword kw">end</span>
74:         <span class="ruby-identifier">scope</span>
75:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000182" class="method-detail">
        <a name="M000182"></a>

        <div class="method-heading">
          <a href="#M000182" class="method-signature">
          <span class="method-name">push_scope</span><span class="method-args">(metric, time = Time.now.to_f, deduct_call_time_from_parent = true)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000182-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000182-source">
<pre>
    <span class="ruby-comment cmt"># File lib/new_relic/agent/stats_engine/transactions.rb, line 34</span>
34:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">push_scope</span>(<span class="ruby-identifier">metric</span>, <span class="ruby-identifier">time</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">to_f</span>, <span class="ruby-identifier">deduct_call_time_from_parent</span> = <span class="ruby-keyword kw">true</span>)
35:         
36:         <span class="ruby-identifier">stack</span> = <span class="ruby-identifier">scope_stack</span>
37:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">collecting_gc?</span>
38:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">stack</span>.<span class="ruby-identifier">empty?</span>
39:             <span class="ruby-comment cmt"># reset the gc time so we only include gc time spent during this call</span>
40:             <span class="ruby-ivar">@last_gc_timestamp</span> = <span class="ruby-constant">GC</span>.<span class="ruby-identifier">time</span>
41:             <span class="ruby-ivar">@last_gc_count</span> = <span class="ruby-constant">GC</span>.<span class="ruby-identifier">collections</span>
42:           <span class="ruby-keyword kw">else</span>
43:             <span class="ruby-identifier">capture_gc_time</span>
44:           <span class="ruby-keyword kw">end</span>
45:         <span class="ruby-keyword kw">end</span>
46:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@transaction_sampler</span>
47:           <span class="ruby-ivar">@transaction_sampler</span>.<span class="ruby-identifier">notice_first_scope_push</span>(<span class="ruby-identifier">time</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">stack</span>.<span class="ruby-identifier">empty?</span> 
48:           <span class="ruby-ivar">@transaction_sampler</span>.<span class="ruby-identifier">notice_push_scope</span> <span class="ruby-identifier">metric</span>, <span class="ruby-identifier">time</span>
49:         <span class="ruby-keyword kw">end</span>
50:         <span class="ruby-identifier">scope</span> = <span class="ruby-constant">ScopeStackElement</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">metric</span>, <span class="ruby-identifier">deduct_call_time_from_parent</span>)
51:         <span class="ruby-identifier">stack</span>.<span class="ruby-identifier">push</span> <span class="ruby-identifier">scope</span>
52:         <span class="ruby-identifier">scope</span>
53:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000181" class="method-detail">
        <a name="M000181"></a>

        <div class="method-heading">
          <a href="#M000181" class="method-signature">
          <span class="method-name">remove_transaction_sampler</span><span class="method-args">(l)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000181-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000181-source">
<pre>
    <span class="ruby-comment cmt"># File lib/new_relic/agent/stats_engine/transactions.rb, line 30</span>
30:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">remove_transaction_sampler</span>(<span class="ruby-identifier">l</span>)
31:         <span class="ruby-ivar">@transaction_sampler</span> = <span class="ruby-keyword kw">nil</span>
32:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000187" class="method-detail">
        <a name="M000187"></a>

        <div class="method-heading">
          <a href="#M000187" class="method-signature">
          <span class="method-name">start_transaction</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000187-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000187-source">
<pre>
    <span class="ruby-comment cmt"># File lib/new_relic/agent/stats_engine/transactions.rb, line 97</span>
97:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">start_transaction</span>
98:         <span class="ruby-constant">Thread</span><span class="ruby-operator">::</span><span class="ruby-identifier">current</span>[<span class="ruby-identifier">:newrelic_scope_stack</span>] = []
99:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000186" class="method-detail">
        <a name="M000186"></a>

        <div class="method-heading">
          <a href="#M000186" class="method-signature">
          <span class="method-name">transaction_name</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000186-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000186-source">
<pre>
    <span class="ruby-comment cmt"># File lib/new_relic/agent/stats_engine/transactions.rb, line 93</span>
93:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">transaction_name</span>
94:         <span class="ruby-constant">Thread</span><span class="ruby-operator">::</span><span class="ruby-identifier">current</span>[<span class="ruby-identifier">:newrelic_transaction_name</span>]
95:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000185" class="method-detail">
        <a name="M000185"></a>

        <div class="method-heading">
          <a href="#M000185" class="method-signature">
          <span class="method-name">transaction_name=</span><span class="method-args">(transaction)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
set the name of the transaction for the current thread, which will be used
to define the scope of all traced methods called on this thread until the
scope stack is empty.
</p>
<p>
currently the transaction name is the name of the controller action that is
invoked via the dispatcher, but conceivably we could use other transaction
names in the future if the traced application does more than service http
request via controller actions
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000185-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000185-source">
<pre>
    <span class="ruby-comment cmt"># File lib/new_relic/agent/stats_engine/transactions.rb, line 89</span>
89:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">transaction_name=</span>(<span class="ruby-identifier">transaction</span>)
90:         <span class="ruby-constant">Thread</span><span class="ruby-operator">::</span><span class="ruby-identifier">current</span>[<span class="ruby-identifier">:newrelic_transaction_name</span>] = <span class="ruby-identifier">transaction</span>
91:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000180" class="method-detail">
        <a name="M000180"></a>

        <div class="method-heading">
          <a href="#M000180" class="method-signature">
          <span class="method-name">transaction_sampler=</span><span class="method-args">(sampler)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000180-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000180-source">
<pre>
    <span class="ruby-comment cmt"># File lib/new_relic/agent/stats_engine/transactions.rb, line 25</span>
25:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">transaction_sampler=</span> <span class="ruby-identifier">sampler</span>
26:         <span class="ruby-identifier">fail</span> <span class="ruby-value str">&quot;Can't add a scope listener midflight in a transaction&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">scope_stack</span>.<span class="ruby-identifier">any?</span>
27:         <span class="ruby-ivar">@transaction_sampler</span> = <span class="ruby-identifier">sampler</span>
28:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>