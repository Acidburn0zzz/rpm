<!DOCTYPE html>

<html>
<head>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">

<title>Class: NewRelic::Agent::TransactionSampler</title>

<link type="text/css" media="screen" href="../../rdoc.css" rel="stylesheet">

<script type="text/javascript">
  var rdoc_rel_prefix = "../../";
</script>

<script type="text/javascript" charset="utf-8" src="../../js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="../../js/navigation.js"></script>
<script type="text/javascript" charset="utf-8" src="../../js/search_index.js"></script>
<script type="text/javascript" charset="utf-8" src="../../js/search.js"></script>
<script type="text/javascript" charset="utf-8" src="../../js/searcher.js"></script>
<script type="text/javascript" charset="utf-8" src="../../js/darkfish.js"></script>


<body id="top" class="class">
<nav id="metadata">
  <nav id="home-section" class="section">
  <h3 class="section-header">
    <a href="../../index.html">Home</a>
    <a href="../../table_of_contents.html#classes">Classes</a>
    <a href="../../table_of_contents.html#methods">Methods</a>
  </h3>
</nav>


  <nav id="search-section" class="section project-section" class="initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <h3 class="section-header">
      <input type="text" name="search" placeholder="Search" id="search-field"
             title="Type to search, Up and Down to navigate, Enter to load">
    </h3>
  </form>

  <ul id="search-results" class="initially-hidden"></ul>
</nav>


  <div id="file-metadata">
    <nav id="file-list-section" class="section">
  <h3 class="section-header">Defined In</h3>
  <ul>
    <li>lib/new_relic/agent/transaction_sampler.rb
  </ul>
</nav>

    
  </div>

  <div id="class-metadata">
    
    <nav id="parent-class-section" class="section">
  <h3 class="section-header">Parent</h3>
  
  <p class="link"><a href="../../Object.html">Object</a>
  
</nav>

    
    <!-- Method Quickref -->
<nav id="method-list-section" class="section">
  <h3 class="section-header">Methods</h3>

  <ul class="link-list">
    
    <li><a href="#method-c-new">::new</a>
    
    <li><a href="#method-i-add_force_persist_to">#add_force_persist_to</a>
    
    <li><a href="#method-i-add_random_sample_to">#add_random_sample_to</a>
    
    <li><a href="#method-i-add_samples_to">#add_samples_to</a>
    
    <li><a href="#method-i-append_backtrace">#append_backtrace</a>
    
    <li><a href="#method-i-append_new_message">#append_new_message</a>
    
    <li><a href="#method-i-builder">#builder</a>
    
    <li><a href="#method-i-capture_segment_trace">#capture_segment_trace</a>
    
    <li><a href="#method-i-clamp_number_tts">#clamp_number_tts</a>
    
    <li><a href="#method-i-clear_builder">#clear_builder</a>
    
    <li><a href="#method-i-config">#config</a>
    
    <li><a href="#method-i-configure-21">#configure!</a>
    
    <li><a href="#method-i-current_sample_id">#current_sample_id</a>
    
    <li><a href="#method-i-disable">#disable</a>
    
    <li><a href="#method-i-enable">#enable</a>
    
    <li><a href="#method-i-enabled-3F">#enabled?</a>
    
    <li><a href="#method-i-harvest">#harvest</a>
    
    <li><a href="#method-i-ignore_transaction">#ignore_transaction</a>
    
    <li><a href="#method-i-notice_first_scope_push">#notice_first_scope_push</a>
    
    <li><a href="#method-i-notice_nosql">#notice_nosql</a>
    
    <li><a href="#method-i-notice_pop_scope">#notice_pop_scope</a>
    
    <li><a href="#method-i-notice_profile">#notice_profile</a>
    
    <li><a href="#method-i-notice_push_scope">#notice_push_scope</a>
    
    <li><a href="#method-i-notice_scope_empty">#notice_scope_empty</a>
    
    <li><a href="#method-i-notice_sql">#notice_sql</a>
    
    <li><a href="#method-i-notice_transaction">#notice_transaction</a>
    
    <li><a href="#method-i-notice_transaction_cpu_time">#notice_transaction_cpu_time</a>
    
    <li><a href="#method-i-reset-21">#reset!</a>
    
    <li><a href="#method-i-sampling_rate-3D">#sampling_rate=</a>
    
    <li><a href="#method-i-scope_depth">#scope_depth</a>
    
    <li><a href="#method-i-slowest_sample-3F">#slowest_sample?</a>
    
    <li><a href="#method-i-start_builder">#start_builder</a>
    
    <li><a href="#method-i-store_force_persist">#store_force_persist</a>
    
    <li><a href="#method-i-store_random_sample">#store_random_sample</a>
    
    <li><a href="#method-i-store_sample">#store_sample</a>
    
    <li><a href="#method-i-store_sample_for_developer_mode">#store_sample_for_developer_mode</a>
    
    <li><a href="#method-i-store_slowest_sample">#store_slowest_sample</a>
    
    <li><a href="#method-i-truncate_message">#truncate_message</a>
    
    <li><a href="#method-i-truncate_samples">#truncate_samples</a>
    
  </ul>
</nav>

  </div>

  <div id="project-metadata">
    <nav id="fileindex-section" class="section project-section">
  <h3 class="section-header">Pages</h3>

  <ul>
  
    <li class="file"><a href="../../CHANGELOG.html">CHANGELOG</a>
  
    <li class="file"><a href="../../LICENSE.html">LICENSE</a>
  
    <li class="file"><a href="../../README_rdoc.html">README</a>
  
  </ul>
</nav>

    <nav id="classindex-section" class="section project-section">
  <h3 class="section-header">Class and Module Index</h3>

  <ul class="link-list">
  
    <li><a href="../../NewRelic.html">NewRelic</a>
  
    <li><a href="../../NewRelic/Agent.html">NewRelic::Agent</a>
  
    <li><a href="../../NewRelic/Agent/Agent.html">NewRelic::Agent::Agent</a>
  
    <li><a href="../../NewRelic/Agent/Agent/ClassMethods.html">NewRelic::Agent::Agent::ClassMethods</a>
  
    <li><a href="../../NewRelic/Agent/Agent/InstanceMethods.html">NewRelic::Agent::Agent::InstanceMethods</a>
  
    <li><a href="../../NewRelic/Agent/Agent/InstanceMethods/Connect.html">NewRelic::Agent::Agent::InstanceMethods::Connect</a>
  
    <li><a href="../../NewRelic/Agent/Agent/InstanceMethods/Start.html">NewRelic::Agent::Agent::InstanceMethods::Start</a>
  
    <li><a href="../../NewRelic/Agent/Agent/InstanceMethods/StartWorkerThread.html">NewRelic::Agent::Agent::InstanceMethods::StartWorkerThread</a>
  
    <li><a href="../../NewRelic/Agent/BackgroundLoadingError.html">NewRelic::Agent::BackgroundLoadingError</a>
  
    <li><a href="../../NewRelic/Agent/BeaconConfiguration.html">NewRelic::Agent::BeaconConfiguration</a>
  
    <li><a href="../../NewRelic/Agent/BrowserMonitoring.html">NewRelic::Agent::BrowserMonitoring</a>
  
    <li><a href="../../NewRelic/Agent/BrowserMonitoring/DummyMetricFrame.html">NewRelic::Agent::BrowserMonitoring::DummyMetricFrame</a>
  
    <li><a href="../../NewRelic/Agent/BusyCalculator.html">NewRelic::Agent::BusyCalculator</a>
  
    <li><a href="../../NewRelic/Agent/Database.html">NewRelic::Agent::Database</a>
  
    <li><a href="../../NewRelic/Agent/Database/ConnectionManager.html">NewRelic::Agent::Database::ConnectionManager</a>
  
    <li><a href="../../NewRelic/Agent/Database/Obfuscator.html">NewRelic::Agent::Database::Obfuscator</a>
  
    <li><a href="../../NewRelic/Agent/ErrorCollector.html">NewRelic::Agent::ErrorCollector</a>
  
    <li><a href="../../NewRelic/Agent/ErrorCollector/NoticeError.html">NewRelic::Agent::ErrorCollector::NoticeError</a>
  
    <li><a href="../../NewRelic/Agent/ForceDisconnectException.html">NewRelic::Agent::ForceDisconnectException</a>
  
    <li><a href="../../NewRelic/Agent/ForceRestartException.html">NewRelic::Agent::ForceRestartException</a>
  
    <li><a href="../../NewRelic/Agent/Instrumentation.html">NewRelic::Agent::Instrumentation</a>
  
    <li><a href="../../NewRelic/Agent/Instrumentation/ActiveRecordInstrumentation.html">NewRelic::Agent::Instrumentation::ActiveRecordInstrumentation</a>
  
    <li><a href="../../NewRelic/Agent/Instrumentation/ControllerInstrumentation.html">NewRelic::Agent::Instrumentation::ControllerInstrumentation</a>
  
    <li><a href="../../NewRelic/Agent/Instrumentation/ControllerInstrumentation/ClassMethods.html">NewRelic::Agent::Instrumentation::ControllerInstrumentation::ClassMethods</a>
  
    <li><a href="../../NewRelic/Agent/Instrumentation/DataMapperInstrumentation.html">NewRelic::Agent::Instrumentation::DataMapperInstrumentation</a>
  
    <li><a href="../../NewRelic/Agent/Instrumentation/Memcache.html">NewRelic::Agent::Instrumentation::Memcache</a>
  
    <li><a href="../../NewRelic/Agent/Instrumentation/MetricFrame.html">NewRelic::Agent::Instrumentation::MetricFrame</a>
  
    <li><a href="../../NewRelic/Agent/Instrumentation/MetricFrame/Pop.html">NewRelic::Agent::Instrumentation::MetricFrame::Pop</a>
  
    <li><a href="../../NewRelic/Agent/Instrumentation/QueueTime.html">NewRelic::Agent::Instrumentation::QueueTime</a>
  
    <li><a href="../../NewRelic/Agent/Instrumentation/Rack.html">NewRelic::Agent::Instrumentation::Rack</a>
  
    <li><a href="../../NewRelic/Agent/Instrumentation/Rails3.html">NewRelic::Agent::Instrumentation::Rails3</a>
  
    <li><a href="../../NewRelic/Agent/Instrumentation/Rails3/ActionController.html">NewRelic::Agent::Instrumentation::Rails3::ActionController</a>
  
    <li><a href="../../NewRelic/Agent/Instrumentation/Rails3/ActionView.html">NewRelic::Agent::Instrumentation::Rails3::ActionView</a>
  
    <li><a href="../../NewRelic/Agent/Instrumentation/Rails3/ActionView/PartialRenderer.html">NewRelic::Agent::Instrumentation::Rails3::ActionView::PartialRenderer</a>
  
    <li><a href="../../NewRelic/Agent/Instrumentation/Rails3/Errors.html">NewRelic::Agent::Instrumentation::Rails3::Errors</a>
  
    <li><a href="../../NewRelic/Agent/Instrumentation/Sinatra.html">NewRelic::Agent::Instrumentation::Sinatra</a>
  
    <li><a href="../../NewRelic/Agent/LicenseException.html">NewRelic::Agent::LicenseException</a>
  
    <li><a href="../../NewRelic/Agent/MethodTracer.html">NewRelic::Agent::MethodTracer</a>
  
    <li><a href="../../NewRelic/Agent/MethodTracer/ClassMethods.html">NewRelic::Agent::MethodTracer::ClassMethods</a>
  
    <li><a href="../../NewRelic/Agent/MethodTracer/ClassMethods/AddMethodTracer.html">NewRelic::Agent::MethodTracer::ClassMethods::AddMethodTracer</a>
  
    <li><a href="../../NewRelic/Agent/MethodTracer/InstanceMethods.html">NewRelic::Agent::MethodTracer::InstanceMethods</a>
  
    <li><a href="../../NewRelic/Agent/MethodTracer/InstanceMethods/TraceExecutionScoped.html">NewRelic::Agent::MethodTracer::InstanceMethods::TraceExecutionScoped</a>
  
    <li><a href="../../NewRelic/Agent/PostTooBigException.html">NewRelic::Agent::PostTooBigException</a>
  
    <li><a href="../../NewRelic/Agent/Sampler.html">NewRelic::Agent::Sampler</a>
  
    <li><a href="../../NewRelic/Agent/Sampler/Unsupported.html">NewRelic::Agent::Sampler::Unsupported</a>
  
    <li><a href="../../NewRelic/Agent/Samplers.html">NewRelic::Agent::Samplers</a>
  
    <li><a href="../../NewRelic/Agent/Samplers/CpuSampler.html">NewRelic::Agent::Samplers::CpuSampler</a>
  
    <li><a href="../../NewRelic/Agent/Samplers/DelayedJobLockSampler.html">NewRelic::Agent::Samplers::DelayedJobLockSampler</a>
  
    <li><a href="../../NewRelic/Agent/Samplers/MemorySampler.html">NewRelic::Agent::Samplers::MemorySampler</a>
  
    <li><a href="../../NewRelic/Agent/Samplers/MemorySampler/Base.html">NewRelic::Agent::Samplers::MemorySampler::Base</a>
  
    <li><a href="../../NewRelic/Agent/Samplers/MemorySampler/JavaHeapSampler.html">NewRelic::Agent::Samplers::MemorySampler::JavaHeapSampler</a>
  
    <li><a href="../../NewRelic/Agent/Samplers/MemorySampler/ProcStatus.html">NewRelic::Agent::Samplers::MemorySampler::ProcStatus</a>
  
    <li><a href="../../NewRelic/Agent/Samplers/MemorySampler/ShellPS.html">NewRelic::Agent::Samplers::MemorySampler::ShellPS</a>
  
    <li><a href="../../NewRelic/Agent/Samplers/ObjectSampler.html">NewRelic::Agent::Samplers::ObjectSampler</a>
  
    <li><a href="../../NewRelic/Agent/ServerConnectionException.html">NewRelic::Agent::ServerConnectionException</a>
  
    <li><a href="../../NewRelic/Agent/ServerError.html">NewRelic::Agent::ServerError</a>
  
    <li><a href="../../NewRelic/Agent/ShimAgent.html">NewRelic::Agent::ShimAgent</a>
  
    <li><a href="../../NewRelic/Agent/SlowSql.html">NewRelic::Agent::SlowSql</a>
  
    <li><a href="../../NewRelic/Agent/SqlSampler.html">NewRelic::Agent::SqlSampler</a>
  
    <li><a href="../../NewRelic/Agent/SqlTrace.html">NewRelic::Agent::SqlTrace</a>
  
    <li><a href="../../NewRelic/Agent/StatsEngine.html">NewRelic::Agent::StatsEngine</a>
  
    <li><a href="../../NewRelic/Agent/StatsEngine/GCProfiler.html">NewRelic::Agent::StatsEngine::GCProfiler</a>
  
    <li><a href="../../NewRelic/Agent/StatsEngine/GCProfiler/Profiler.html">NewRelic::Agent::StatsEngine::GCProfiler::Profiler</a>
  
    <li><a href="../../NewRelic/Agent/StatsEngine/GCProfiler/RailsBench.html">NewRelic::Agent::StatsEngine::GCProfiler::RailsBench</a>
  
    <li><a href="../../NewRelic/Agent/StatsEngine/GCProfiler/Rubinius.html">NewRelic::Agent::StatsEngine::GCProfiler::Rubinius</a>
  
    <li><a href="../../NewRelic/Agent/StatsEngine/GCProfiler/Ruby19.html">NewRelic::Agent::StatsEngine::GCProfiler::Ruby19</a>
  
    <li><a href="../../NewRelic/Agent/StatsEngine/MetricStats.html">NewRelic::Agent::StatsEngine::MetricStats</a>
  
    <li><a href="../../NewRelic/Agent/StatsEngine/MetricStats/Harvest.html">NewRelic::Agent::StatsEngine::MetricStats::Harvest</a>
  
    <li><a href="../../NewRelic/Agent/StatsEngine/MetricStats/SynchronizedHash.html">NewRelic::Agent::StatsEngine::MetricStats::SynchronizedHash</a>
  
    <li><a href="../../NewRelic/Agent/StatsEngine/Samplers.html">NewRelic::Agent::StatsEngine::Samplers</a>
  
    <li><a href="../../NewRelic/Agent/StatsEngine/ScopeStackElement.html">NewRelic::Agent::StatsEngine::ScopeStackElement</a>
  
    <li><a href="../../NewRelic/Agent/StatsEngine/Transactions.html">NewRelic::Agent::StatsEngine::Transactions</a>
  
    <li><a href="../../NewRelic/Agent/TransactionInfo.html">NewRelic::Agent::TransactionInfo</a>
  
    <li><a href="../../NewRelic/Agent/TransactionSampleBuilder.html">NewRelic::Agent::TransactionSampleBuilder</a>
  
    <li><a href="../../NewRelic/Agent/TransactionSampler.html">NewRelic::Agent::TransactionSampler</a>
  
    <li><a href="../../NewRelic/Agent/TransactionSqlData.html">NewRelic::Agent::TransactionSqlData</a>
  
    <li><a href="../../NewRelic/Agent/WorkerLoop.html">NewRelic::Agent::WorkerLoop</a>
  
    <li><a href="../../NewRelic/ApdexStats.html">NewRelic::ApdexStats</a>
  
    <li><a href="../../NewRelic/BasicStats.html">NewRelic::BasicStats</a>
  
    <li><a href="../../NewRelic/ChainedCall.html">NewRelic::ChainedCall</a>
  
    <li><a href="../../NewRelic/CollectionHelper.html">NewRelic::CollectionHelper</a>
  
    <li><a href="../../NewRelic/Command.html">NewRelic::Command</a>
  
    <li><a href="../../NewRelic/Command/CommandFailure.html">NewRelic::Command::CommandFailure</a>
  
    <li><a href="../../NewRelic/Command/Deployments.html">NewRelic::Command::Deployments</a>
  
    <li><a href="../../NewRelic/Command/Install.html">NewRelic::Command::Install</a>
  
    <li><a href="../../NewRelic/Control.html">NewRelic::Control</a>
  
    <li><a href="../../NewRelic/Control/ClassMethods.html">NewRelic::Control::ClassMethods</a>
  
    <li><a href="../../NewRelic/Control/Configuration.html">NewRelic::Control::Configuration</a>
  
    <li><a href="../../NewRelic/Control/Frameworks.html">NewRelic::Control::Frameworks</a>
  
    <li><a href="../../NewRelic/Control/Frameworks/External.html">NewRelic::Control::Frameworks::External</a>
  
    <li><a href="../../NewRelic/Control/Frameworks/Merb.html">NewRelic::Control::Frameworks::Merb</a>
  
    <li><a href="../../NewRelic/Control/Frameworks/Rails.html">NewRelic::Control::Frameworks::Rails</a>
  
    <li><a href="../../NewRelic/Control/Frameworks/Rails3.html">NewRelic::Control::Frameworks::Rails3</a>
  
    <li><a href="../../NewRelic/Control/Frameworks/Ruby.html">NewRelic::Control::Frameworks::Ruby</a>
  
    <li><a href="../../NewRelic/Control/Frameworks/Sinatra.html">NewRelic::Control::Frameworks::Sinatra</a>
  
    <li><a href="../../NewRelic/Control/InstanceMethods.html">NewRelic::Control::InstanceMethods</a>
  
    <li><a href="../../NewRelic/Control/Instrumentation.html">NewRelic::Control::Instrumentation</a>
  
    <li><a href="../../NewRelic/Control/LoggingMethods.html">NewRelic::Control::LoggingMethods</a>
  
    <li><a href="../../NewRelic/Control/Profiling.html">NewRelic::Control::Profiling</a>
  
    <li><a href="../../NewRelic/Control/ServerMethods.html">NewRelic::Control::ServerMethods</a>
  
    <li><a href="../../NewRelic/DataSerialization.html">NewRelic::DataSerialization</a>
  
    <li><a href="../../NewRelic/DataSerialization/ClassMethods.html">NewRelic::DataSerialization::ClassMethods</a>
  
    <li><a href="../../NewRelic/DelayedJobInjection.html">NewRelic::DelayedJobInjection</a>
  
    <li><a href="../../NewRelic/Instrumentation.html">NewRelic::Instrumentation</a>
  
    <li><a href="../../NewRelic/Instrumentation/ActsAsSolrInstrumentation.html">NewRelic::Instrumentation::ActsAsSolrInstrumentation</a>
  
    <li><a href="../../NewRelic/Instrumentation/ActsAsSolrInstrumentation/ParserMethodsInstrumentation.html">NewRelic::Instrumentation::ActsAsSolrInstrumentation::ParserMethodsInstrumentation</a>
  
    <li><a href="../../NewRelic/LanguageSupport.html">NewRelic::LanguageSupport</a>
  
    <li><a href="../../NewRelic/LanguageSupport/Control.html">NewRelic::LanguageSupport::Control</a>
  
    <li><a href="../../NewRelic/LanguageSupport/DataSerialization.html">NewRelic::LanguageSupport::DataSerialization</a>
  
    <li><a href="../../NewRelic/LanguageSupport/SynchronizedHash.html">NewRelic::LanguageSupport::SynchronizedHash</a>
  
    <li><a href="../../NewRelic/LocalEnvironment.html">NewRelic::LocalEnvironment</a>
  
    <li><a href="../../NewRelic/MerbBootLoader.html">NewRelic::MerbBootLoader</a>
  
    <li><a href="../../NewRelic/MethodTraceStats.html">NewRelic::MethodTraceStats</a>
  
    <li><a href="../../NewRelic/MetricData.html">NewRelic::MetricData</a>
  
    <li><a href="../../NewRelic/MetricSpec.html">NewRelic::MetricSpec</a>
  
    <li><a href="../../NewRelic/Metrics.html">NewRelic::Metrics</a>
  
    <li><a href="../../NewRelic/NoticedError.html">NewRelic::NoticedError</a>
  
    <li><a href="../../NewRelic/Rack.html">NewRelic::Rack</a>
  
    <li><a href="../../NewRelic/Rack/BrowserMonitoring.html">NewRelic::Rack::BrowserMonitoring</a>
  
    <li><a href="../../NewRelic/Rack/DeveloperMode.html">NewRelic::Rack::DeveloperMode</a>
  
    <li><a href="../../NewRelic/Railtie.html">NewRelic::Railtie</a>
  
    <li><a href="../../NewRelic/ScopedMethodTraceStats.html">NewRelic::ScopedMethodTraceStats</a>
  
    <li><a href="../../NewRelic/Stats.html">NewRelic::Stats</a>
  
    <li><a href="../../NewRelic/StatsBase.html">NewRelic::StatsBase</a>
  
    <li><a href="../../NewRelic/TransactionAnalysis.html">NewRelic::TransactionAnalysis</a>
  
    <li><a href="../../NewRelic/TransactionAnalysis/SegmentSummary.html">NewRelic::TransactionAnalysis::SegmentSummary</a>
  
    <li><a href="../../NewRelic/TransactionSample.html">NewRelic::TransactionSample</a>
  
    <li><a href="../../NewRelic/TransactionSample/CompositeSegment.html">NewRelic::TransactionSample::CompositeSegment</a>
  
    <li><a href="../../NewRelic/TransactionSample/FakeSegment.html">NewRelic::TransactionSample::FakeSegment</a>
  
    <li><a href="../../NewRelic/TransactionSample/Segment.html">NewRelic::TransactionSample::Segment</a>
  
    <li><a href="../../NewRelic/TransactionSample/SummarySegment.html">NewRelic::TransactionSample::SummarySegment</a>
  
    <li><a href="../../NewRelic/UrlRule.html">NewRelic::UrlRule</a>
  
    <li><a href="../../NewRelic/UrlRule/RuleSet.html">NewRelic::UrlRule::RuleSet</a>
  
    <li><a href="../../NewRelic/VersionNumber.html">NewRelic::VersionNumber</a>
  
    <li><a href="../../ActionView.html">ActionView</a>
  
    <li><a href="../../ActionView/Base.html">ActionView::Base</a>
  
    <li><a href="../../ActionView/Partials.html">ActionView::Partials</a>
  
    <li><a href="../../ActionView/Partials/PartialRenderer.html">ActionView::Partials::PartialRenderer</a>
  
    <li><a href="../../ActionController.html">ActionController</a>
  
    <li><a href="../../ActionController/Base.html">ActionController::Base</a>
  
    <li><a href="../../Object.html">Object</a>
  
  </ul>
</nav>

  </div>
</nav>

<div id="documentation">
  <h1 class="class">class NewRelic::Agent::TransactionSampler</h1>

  <div id="description" class="description">
    
<p>This class contains the logic of sampling a transaction - creation and
modification of transaction samples</p>

  </div><!-- description -->

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    
    <!-- Constants -->
    <section id="constants-list" class="section">
      <h3 class="section-header">Constants</h3>
      <dl>
      
        <dt id="BUILDER_KEY">BUILDER_KEY
        
        <dd class="description">
        
      
        <dt id="MAX_DATA_LENGTH">MAX_DATA_LENGTH
        
        <dd class="description">
        
      
      </dl>
    </section>
    

    
    <!-- Attributes -->
    <section id="attribute-method-details" class="method-section section">
      <h3 class="section-header">Attributes</h3>

      
      <div id="attribute-i-disabled" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">disabled</span><span
            class="attribute-access-type">[R]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-explain_enabled" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">explain_enabled</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-explain_threshold" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">explain_threshold</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-last_sample" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">last_sample</span><span
            class="attribute-access-type">[R]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-random_sampling" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">random_sampling</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-samples" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">samples</span><span
            class="attribute-access-type">[R]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-sampling_rate" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">sampling_rate</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-slow_capture_threshold" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">slow_capture_threshold</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-stack_trace_threshold" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">stack_trace_threshold</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-transaction_threshold" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">transaction_threshold</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
    </section><!-- attribute-method-details -->
    

    <!-- Methods -->
    
     <section id="public-class-5Buntitled-5D-method-details" class="method-section section">
      <h3 class="section-header">Public Class Methods</h3>

    
      <div id="method-c-new" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="new-source">
            <pre><span class="ruby-comment"># File lib/new_relic/agent/transaction_sampler.rb, line 26</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">initialize</span>
  <span class="ruby-comment"># @samples is an array of recent samples up to @max_samples in</span>
  <span class="ruby-comment"># size - it's only used by developer mode</span>
  <span class="ruby-ivar">@samples</span> = []
  <span class="ruby-ivar">@force_persist</span> = []
  <span class="ruby-ivar">@max_samples</span> = <span class="ruby-value">100</span>

  <span class="ruby-comment"># @harvest_count is a count of harvests used for random</span>
  <span class="ruby-comment"># sampling - we pull 1 @random_sample in every @sampling_rate harvests</span>
  <span class="ruby-ivar">@harvest_count</span> = <span class="ruby-value">0</span>
  <span class="ruby-ivar">@random_sample</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-ivar">@sampling_rate</span> = <span class="ruby-value">10</span>
  <span class="ruby-ivar">@slow_capture_threshold</span> = <span class="ruby-value">2.0</span>
  <span class="ruby-identifier">configure!</span>

  <span class="ruby-comment"># This lock is used to synchronize access to the @last_sample</span>
  <span class="ruby-comment"># and related variables. It can become necessary on JRuby or</span>
  <span class="ruby-comment"># any 'honest-to-god'-multithreaded system</span>
  <span class="ruby-ivar">@samples_lock</span> = <span class="ruby-constant">Mutex</span>.<span class="ruby-identifier">new</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- new-source -->
          
        </div>

        

        
      </div><!-- new-method -->

    
    </section><!-- public-class-method-details -->
  
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section section">
      <h3 class="section-header">Public Instance Methods</h3>

    
      <div id="method-i-add_force_persist_to" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">add_force_persist_to</span><span
            class="method-args">(result)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="add_force_persist_to-source">
            <pre><span class="ruby-comment"># File lib/new_relic/agent/transaction_sampler.rb, line 343</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">add_force_persist_to</span>(<span class="ruby-identifier">result</span>)
  <span class="ruby-identifier">result</span>.<span class="ruby-identifier">concat</span>(<span class="ruby-ivar">@force_persist</span>)
  <span class="ruby-ivar">@force_persist</span> = []
<span class="ruby-keyword">end</span></pre>
          </div><!-- add_force_persist_to-source -->
          
        </div>

        

        
      </div><!-- add_force_persist_to-method -->

    
      <div id="method-i-add_random_sample_to" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">add_random_sample_to</span><span
            class="method-args">(result)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Every 1/n harvests, adds the most recent sample to the harvest array if it
exists. Makes sure that the random sample is not also the slowest sample
for this harvest by `uniq!`ing the result array</p>

<p>random sampling is very, very seldom used</p>
          

          
          <div class="method-source-code" id="add_random_sample_to-source">
            <pre><span class="ruby-comment"># File lib/new_relic/agent/transaction_sampler.rb, line 334</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">add_random_sample_to</span>(<span class="ruby-identifier">result</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@random_sampling</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@sampling_rate</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@sampling_rate</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
  <span class="ruby-ivar">@harvest_count</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
  <span class="ruby-keyword">if</span> (<span class="ruby-ivar">@harvest_count</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">%</span> <span class="ruby-ivar">@sampling_rate</span>.<span class="ruby-identifier">to_i</span>) <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
    <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@random_sample</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@random_sample</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">nil</span> <span class="ruby-comment"># don't assume this method returns anything</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- add_random_sample_to-source -->
          
        </div>

        

        
      </div><!-- add_random_sample_to-method -->

    
      <div id="method-i-add_samples_to" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">add_samples_to</span><span
            class="method-args">(result, slow_threshold)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Returns an array of slow samples, with either one or two elements - one
element unless random sampling is enabled. The sample returned will be the
slowest sample among those available during this harvest</p>
          

          
          <div class="method-source-code" id="add_samples_to-source">
            <pre><span class="ruby-comment"># File lib/new_relic/agent/transaction_sampler.rb, line 352</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">add_samples_to</span>(<span class="ruby-identifier">result</span>, <span class="ruby-identifier">slow_threshold</span>)
  
  <span class="ruby-comment"># pull out force persist</span>
  <span class="ruby-identifier">force_persist</span> = <span class="ruby-identifier">result</span>.<span class="ruby-identifier">select</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">sample</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sample</span>.<span class="ruby-identifier">force_persist</span>} <span class="ruby-operator">||</span> []
  <span class="ruby-identifier">result</span>.<span class="ruby-identifier">reject!</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">sample</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sample</span>.<span class="ruby-identifier">force_persist</span>}
  
  <span class="ruby-identifier">force_persist</span>.<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">sample</span><span class="ruby-operator">|</span> <span class="ruby-identifier">store_force_persist</span>(<span class="ruby-identifier">sample</span>)}
  
  
  <span class="ruby-comment"># Now get the slowest sample</span>
  <span class="ruby-keyword">if</span> <span class="ruby-ivar">@slowest_sample</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@slowest_sample</span>.<span class="ruby-identifier">duration</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-identifier">slow_threshold</span>
    <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-ivar">@slowest_sample</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">result</span>.<span class="ruby-identifier">compact!</span>
  <span class="ruby-identifier">result</span> = <span class="ruby-identifier">result</span>.<span class="ruby-identifier">sort_by</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">x</span><span class="ruby-operator">|</span> <span class="ruby-identifier">x</span>.<span class="ruby-identifier">duration</span> }
  <span class="ruby-identifier">result</span> = <span class="ruby-identifier">result</span>[<span class="ruby-value">-1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>] <span class="ruby-operator">||</span> []               <span class="ruby-comment"># take the slowest sample</span>
  
  <span class="ruby-identifier">add_random_sample_to</span>(<span class="ruby-identifier">result</span>)
  <span class="ruby-identifier">add_force_persist_to</span>(<span class="ruby-identifier">result</span>)
  
  <span class="ruby-identifier">result</span>.<span class="ruby-identifier">uniq</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- add_samples_to-source -->
          
        </div>

        

        
      </div><!-- add_samples_to-method -->

    
      <div id="method-i-append_backtrace" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">append_backtrace</span><span
            class="method-args">(segment, duration)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Appends a backtrace to a segment if that segment took longer than the
specified duration</p>
          

          
          <div class="method-source-code" id="append_backtrace-source">
            <pre><span class="ruby-comment"># File lib/new_relic/agent/transaction_sampler.rb, line 306</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">append_backtrace</span>(<span class="ruby-identifier">segment</span>, <span class="ruby-identifier">duration</span>)
  <span class="ruby-identifier">segment</span>[<span class="ruby-value">:backtrace</span>] = <span class="ruby-identifier">caller</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;\n&quot;</span>) <span class="ruby-keyword">if</span> (<span class="ruby-identifier">duration</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-ivar">@stack_trace_threshold</span> <span class="ruby-operator">||</span> <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">current</span>[<span class="ruby-value">:capture_deep_tt</span>])
<span class="ruby-keyword">end</span></pre>
          </div><!-- append_backtrace-source -->
          
        </div>

        

        
      </div><!-- append_backtrace-method -->

    
      <div id="method-i-append_new_message" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">append_new_message</span><span
            class="method-args">(old_message, message)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Allows the addition of multiple pieces of metadata to one segment - i.e.
traced method calls multiple sql queries</p>
          

          
          <div class="method-source-code" id="append_new_message-source">
            <pre><span class="ruby-comment"># File lib/new_relic/agent/transaction_sampler.rb, line 296</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">append_new_message</span>(<span class="ruby-identifier">old_message</span>, <span class="ruby-identifier">message</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">old_message</span>
    <span class="ruby-identifier">old_message</span> <span class="ruby-operator">+</span> <span class="ruby-string">&quot;;\n&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">message</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">message</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- append_new_message-source -->
          
        </div>

        

        
      </div><!-- append_new_message-method -->

    
      <div id="method-i-builder" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">builder</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>The current thread-local transaction sample builder</p>
          

          
          <div class="method-source-code" id="builder-source">
            <pre><span class="ruby-comment"># File lib/new_relic/agent/transaction_sampler.rb, line 443</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">builder</span>
  <span class="ruby-constant">Thread</span><span class="ruby-operator">::</span><span class="ruby-identifier">current</span>[<span class="ruby-constant">BUILDER_KEY</span>]
<span class="ruby-keyword">end</span></pre>
          </div><!-- builder-source -->
          
        </div>

        

        
      </div><!-- builder-method -->

    
      <div id="method-i-capture_segment_trace" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">capture_segment_trace</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>in developer mode, capture the stack trace with the segment. this is cpu
and memory expensive and therefore should not be turned on in production
mode</p>
          

          
          <div class="method-source-code" id="capture_segment_trace-source">
            <pre><span class="ruby-comment"># File lib/new_relic/agent/transaction_sampler.rb, line 122</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">capture_segment_trace</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Control</span>.<span class="ruby-identifier">instance</span>.<span class="ruby-identifier">developer_mode?</span>
  <span class="ruby-identifier">segment</span> = <span class="ruby-identifier">builder</span>.<span class="ruby-identifier">current_segment</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">segment</span>
    <span class="ruby-comment"># Strip stack frames off the top that match /new_relic/agent/</span>
    <span class="ruby-identifier">trace</span> = <span class="ruby-identifier">caller</span>
    <span class="ruby-keyword">while</span> <span class="ruby-identifier">trace</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">=~</span><span class="ruby-regexp">/\/lib\/new_relic\/agent\//</span>
      <span class="ruby-identifier">trace</span>.<span class="ruby-identifier">shift</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">trace</span> = <span class="ruby-identifier">trace</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">39</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">trace</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">40</span>
    <span class="ruby-identifier">segment</span>[<span class="ruby-value">:backtrace</span>] = <span class="ruby-identifier">trace</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- capture_segment_trace-source -->
          
        </div>

        

        
      </div><!-- capture_segment_trace-method -->

    
      <div id="method-i-clamp_number_tts" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">clamp_number_tts</span><span
            class="method-args">(tts, limit)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>JON - THIS CODE NEEDS A UNIT TEST</p>
          

          
          <div class="method-source-code" id="clamp_number_tts-source">
            <pre><span class="ruby-comment"># File lib/new_relic/agent/transaction_sampler.rb, line 404</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">clamp_number_tts</span>(<span class="ruby-identifier">tts</span>, <span class="ruby-identifier">limit</span>)
  <span class="ruby-identifier">tts</span>.<span class="ruby-identifier">sort!</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">a</span>,<span class="ruby-identifier">b</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">a</span>.<span class="ruby-identifier">force_persist</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">b</span>.<span class="ruby-identifier">force_persist</span>
      <span class="ruby-identifier">b</span>.<span class="ruby-identifier">duration</span> <span class="ruby-operator">&lt;=&gt;</span> <span class="ruby-identifier">a</span>.<span class="ruby-identifier">duration</span>
    <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">a</span>.<span class="ruby-identifier">force_persist</span>
      <span class="ruby-value">-1</span>
    <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">b</span>.<span class="ruby-identifier">force_persist</span>
      <span class="ruby-value">1</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">b</span>.<span class="ruby-identifier">duration</span> <span class="ruby-operator">&lt;=&gt;</span> <span class="ruby-identifier">a</span>.<span class="ruby-identifier">duration</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>        
  
  <span class="ruby-identifier">tts</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span>(<span class="ruby-identifier">limit</span><span class="ruby-operator">-</span><span class="ruby-value">1</span>)]  
<span class="ruby-keyword">end</span></pre>
          </div><!-- clamp_number_tts-source -->
          
        </div>

        

        
      </div><!-- clamp_number_tts-method -->

    
      <div id="method-i-clear_builder" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">clear_builder</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Sets the thread local variable storing the transaction sample builder to
nil to clear it</p>
          

          
          <div class="method-source-code" id="clear_builder-source">
            <pre><span class="ruby-comment"># File lib/new_relic/agent/transaction_sampler.rb, line 449</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">clear_builder</span>
  <span class="ruby-constant">Thread</span><span class="ruby-operator">::</span><span class="ruby-identifier">current</span>[<span class="ruby-constant">BUILDER_KEY</span>] = <span class="ruby-keyword">nil</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- clear_builder-source -->
          
        </div>

        

        
      </div><!-- clear_builder-method -->

    
      <div id="method-i-config" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">config</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="config-source">
            <pre><span class="ruby-comment"># File lib/new_relic/agent/transaction_sampler.rb, line 61</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">config</span>
  <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Control</span>.<span class="ruby-identifier">instance</span>.<span class="ruby-identifier">fetch</span>(<span class="ruby-string">'transaction_tracer'</span>, {})
<span class="ruby-keyword">end</span></pre>
          </div><!-- config-source -->
          
        </div>

        

        
      </div><!-- config-method -->

    
      <div id="method-i-configure-21" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">configure!</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="configure-21-source">
            <pre><span class="ruby-comment"># File lib/new_relic/agent/transaction_sampler.rb, line 47</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">configure!</span>
  <span class="ruby-comment"># @segment_limit and @stack_trace_threshold come from the</span>
  <span class="ruby-comment"># configuration file, with built-in defaults that should</span>
  <span class="ruby-comment"># suffice for most customers</span>
  
  <span class="ruby-comment"># enable if config.fetch('enabled', true)</span>
  
  <span class="ruby-ivar">@segment_limit</span> = <span class="ruby-identifier">config</span>.<span class="ruby-identifier">fetch</span>(<span class="ruby-string">'limit_segments'</span>, <span class="ruby-value">4000</span>)
  <span class="ruby-ivar">@stack_trace_threshold</span> = <span class="ruby-identifier">config</span>.<span class="ruby-identifier">fetch</span>(<span class="ruby-string">'stack_trace_threshold'</span>, <span class="ruby-value">0.500</span>).<span class="ruby-identifier">to_f</span>
  <span class="ruby-ivar">@explain_threshold</span> = <span class="ruby-identifier">config</span>.<span class="ruby-identifier">fetch</span>(<span class="ruby-string">'explain_threshold'</span>, <span class="ruby-value">0.5</span>).<span class="ruby-identifier">to_f</span>
  <span class="ruby-ivar">@explain_enabled</span> = <span class="ruby-identifier">config</span>.<span class="ruby-identifier">fetch</span>(<span class="ruby-string">'explain_enabled'</span>, <span class="ruby-keyword">true</span>)
  <span class="ruby-ivar">@transaction_threshold</span> = <span class="ruby-identifier">config</span>.<span class="ruby-identifier">fetch</span>(<span class="ruby-string">'transation_threshold'</span>, <span class="ruby-value">2.0</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- configure-21-source -->
          
        </div>

        

        
      </div><!-- configure-21-method -->

    
      <div id="method-i-current_sample_id" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">current_sample_id</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Returns the current sample id, delegated from `builder`</p>
          

          
          <div class="method-source-code" id="current_sample_id-source">
            <pre><span class="ruby-comment"># File lib/new_relic/agent/transaction_sampler.rb, line 66</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">current_sample_id</span>
  <span class="ruby-identifier">b</span>=<span class="ruby-identifier">builder</span>
  <span class="ruby-identifier">b</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">b</span>.<span class="ruby-identifier">sample_id</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- current_sample_id-source -->
          
        </div>

        

        
      </div><!-- current_sample_id-method -->

    
      <div id="method-i-disable" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">disable</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Disable the transaction sampler - this also deregisters it with the
statistics engine.</p>
          

          
          <div class="method-source-code" id="disable-source">
            <pre><span class="ruby-comment"># File lib/new_relic/agent/transaction_sampler.rb, line 80</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">disable</span>
  <span class="ruby-ivar">@disabled</span> = <span class="ruby-keyword">true</span>
  <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Agent</span>.<span class="ruby-identifier">instance</span>.<span class="ruby-identifier">stats_engine</span>.<span class="ruby-identifier">remove_transaction_sampler</span>(<span class="ruby-keyword">self</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- disable-source -->
          
        </div>

        

        
      </div><!-- disable-method -->

    
      <div id="method-i-enable" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">enable</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Enable the transaction sampler - this also registers it with the statistics
engine.</p>
          

          
          <div class="method-source-code" id="enable-source">
            <pre><span class="ruby-comment"># File lib/new_relic/agent/transaction_sampler.rb, line 73</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">enable</span>
  <span class="ruby-ivar">@disabled</span> = <span class="ruby-keyword">false</span>
  <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Agent</span>.<span class="ruby-identifier">instance</span>.<span class="ruby-identifier">stats_engine</span>.<span class="ruby-identifier">transaction_sampler</span> = <span class="ruby-keyword">self</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- enable-source -->
          
        </div>

        

        
      </div><!-- enable-method -->

    
      <div id="method-i-enabled-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">enabled?</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="enabled-3F-source">
            <pre><span class="ruby-comment"># File lib/new_relic/agent/transaction_sampler.rb, line 85</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">enabled?</span>
  <span class="ruby-operator">!</span><span class="ruby-ivar">@disabled</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- enabled-3F-source -->
          
        </div>

        

        
      </div><!-- enabled-3F-method -->

    
      <div id="method-i-harvest" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">harvest</span><span
            class="method-args">(previous = [], slow_threshold = 2.0)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>get the set of collected samples, merging into previous samples, and clear
the collected sample list. Truncates samples to a specified @segment_limit
to save memory and bandwith transmitting samples to the server.</p>
          

          
          <div class="method-source-code" id="harvest-source">
            <pre><span class="ruby-comment"># File lib/new_relic/agent/transaction_sampler.rb, line 380</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">harvest</span>(<span class="ruby-identifier">previous</span> = [], <span class="ruby-identifier">slow_threshold</span> = <span class="ruby-value">2.0</span>)
  <span class="ruby-keyword">return</span> [] <span class="ruby-keyword">if</span> <span class="ruby-identifier">disabled</span>
  <span class="ruby-identifier">result</span> = <span class="ruby-constant">Array</span>(<span class="ruby-identifier">previous</span>)
  
  <span class="ruby-ivar">@samples_lock</span>.<span class="ruby-identifier">synchronize</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">result</span> = <span class="ruby-identifier">add_samples_to</span>(<span class="ruby-identifier">result</span>, <span class="ruby-identifier">slow_threshold</span>)
              
    <span class="ruby-comment"># clear previous transaction samples</span>
    <span class="ruby-ivar">@slowest_sample</span> = <span class="ruby-keyword">nil</span>
    <span class="ruby-ivar">@random_sample</span> = <span class="ruby-keyword">nil</span>
    <span class="ruby-ivar">@last_sample</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-keyword">end</span>
  
  <span class="ruby-comment"># Clamp the number of TTs we'll keep in memory and send</span>
  <span class="ruby-comment">#</span>
  <span class="ruby-identifier">result</span> = <span class="ruby-identifier">clamp_number_tts</span>(<span class="ruby-identifier">result</span>, <span class="ruby-value">20</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">result</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">20</span>
  
  <span class="ruby-comment"># Truncate the samples at 2100 segments. The UI will clamp them at 2000 segments anyway.</span>
  <span class="ruby-comment"># This will save us memory and bandwidth.</span>
  <span class="ruby-identifier">result</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">sample</span><span class="ruby-operator">|</span> <span class="ruby-identifier">sample</span>.<span class="ruby-identifier">truncate</span>(<span class="ruby-ivar">@segment_limit</span>) }
  <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- harvest-source -->
          
        </div>

        

        
      </div><!-- harvest-method -->

    
      <div id="method-i-ignore_transaction" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">ignore_transaction</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Tells the builder to ignore a transaction, if we are currently creating
one. Only causes the sample to be ignored upon end of the transaction, and
does not change the metrics gathered outside of the sampler</p>
          

          
          <div class="method-source-code" id="ignore_transaction-source">
            <pre><span class="ruby-comment"># File lib/new_relic/agent/transaction_sampler.rb, line 251</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">ignore_transaction</span>
  <span class="ruby-identifier">builder</span>.<span class="ruby-identifier">ignore_transaction</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">builder</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- ignore_transaction-source -->
          
        </div>

        

        
      </div><!-- ignore_transaction-method -->

    
      <div id="method-i-notice_first_scope_push" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">notice_first_scope_push</span><span
            class="method-args">(time)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Creates a new transaction sample builder, unless the transaction sampler is
disabled. Takes a time parameter for the start of the transaction sample</p>
          

          
          <div class="method-source-code" id="notice_first_scope_push-source">
            <pre><span class="ruby-comment"># File lib/new_relic/agent/transaction_sampler.rb, line 101</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">notice_first_scope_push</span>(<span class="ruby-identifier">time</span>)
  <span class="ruby-identifier">start_builder</span>(<span class="ruby-identifier">time</span>.<span class="ruby-identifier">to_f</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">disabled</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- notice_first_scope_push-source -->
          
        </div>

        

        
      </div><!-- notice_first_scope_push-method -->

    
      <div id="method-i-notice_nosql" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">notice_nosql</span><span
            class="method-args">(key, duration)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Adds non-sql metadata to a segment - generally the memcached key</p>

<p>duration is seconds, float value.</p>
          

          
          <div class="method-source-code" id="notice_nosql-source">
            <pre><span class="ruby-comment"># File lib/new_relic/agent/transaction_sampler.rb, line 324</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">notice_nosql</span>(<span class="ruby-identifier">key</span>, <span class="ruby-identifier">duration</span>)
  <span class="ruby-identifier">notice_extra_data</span>(<span class="ruby-identifier">key</span>, <span class="ruby-identifier">duration</span>, <span class="ruby-value">:key</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- notice_nosql-source -->
          
        </div>

        

        
      </div><!-- notice_nosql-method -->

    
      <div id="method-i-notice_pop_scope" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">notice_pop_scope</span><span
            class="method-args">(scope, time = Time.now)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Informs the transaction sample builder about the end of a traced scope</p>
          

          
          <div class="method-source-code" id="notice_pop_scope-source">
            <pre><span class="ruby-comment"># File lib/new_relic/agent/transaction_sampler.rb, line 147</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">notice_pop_scope</span>(<span class="ruby-identifier">scope</span>, <span class="ruby-identifier">time</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">builder</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;frozen already???&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">builder</span>.<span class="ruby-identifier">sample</span>.<span class="ruby-identifier">frozen?</span>
  <span class="ruby-identifier">builder</span>.<span class="ruby-identifier">trace_exit</span>(<span class="ruby-identifier">scope</span>, <span class="ruby-identifier">time</span>.<span class="ruby-identifier">to_f</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- notice_pop_scope-source -->
          
        </div>

        

        
      </div><!-- notice_pop_scope-method -->

    
      <div id="method-i-notice_profile" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">notice_profile</span><span
            class="method-args">(profile)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>For developer mode profiling support - delegates to the builder</p>
          

          
          <div class="method-source-code" id="notice_profile-source">
            <pre><span class="ruby-comment"># File lib/new_relic/agent/transaction_sampler.rb, line 256</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">notice_profile</span>(<span class="ruby-identifier">profile</span>)
  <span class="ruby-identifier">builder</span>.<span class="ruby-identifier">set_profile</span>(<span class="ruby-identifier">profile</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">builder</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- notice_profile-source -->
          
        </div>

        

        
      </div><!-- notice_profile-method -->

    
      <div id="method-i-notice_push_scope" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">notice_push_scope</span><span
            class="method-args">(scope, time=Time.now)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>This delegates to the builder to create a new open transaction segment for
the specified scope, beginning at the optionally specified time.</p>

<p>Note that in developer mode, this captures a stacktrace for the beginning
of each segment, which can be fairly slow</p>
          

          
          <div class="method-source-code" id="notice_push_scope-source">
            <pre><span class="ruby-comment"># File lib/new_relic/agent/transaction_sampler.rb, line 111</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">notice_push_scope</span>(<span class="ruby-identifier">scope</span>, <span class="ruby-identifier">time</span>=<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">builder</span>

  <span class="ruby-identifier">builder</span>.<span class="ruby-identifier">trace_entry</span>(<span class="ruby-identifier">scope</span>, <span class="ruby-identifier">time</span>.<span class="ruby-identifier">to_f</span>)

  <span class="ruby-identifier">capture_segment_trace</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Control</span>.<span class="ruby-identifier">instance</span>.<span class="ruby-identifier">developer_mode?</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- notice_push_scope-source -->
          
        </div>

        

        
      </div><!-- notice_push_scope-method -->

    
      <div id="method-i-notice_scope_empty" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">notice_scope_empty</span><span
            class="method-args">(time=Time.now)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>This is called when we are done with the transaction.  We’ve unwound the
stack to the top level. It also clears the transaction sample builder so
that it won’t continue to have scopes appended to it.</p>

<p>It sets various instance variables to the finished sample, depending on
which settings are active. See `<a
href="TransactionSampler.html#method-i-store_sample">#store_sample</a>`</p>
          

          
          <div class="method-source-code" id="notice_scope_empty-source">
            <pre><span class="ruby-comment"># File lib/new_relic/agent/transaction_sampler.rb, line 160</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">notice_scope_empty</span>(<span class="ruby-identifier">time</span>=<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>)

  <span class="ruby-identifier">last_builder</span> = <span class="ruby-identifier">builder</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">last_builder</span>

  <span class="ruby-identifier">last_builder</span>.<span class="ruby-identifier">finish_trace</span>(<span class="ruby-identifier">time</span>.<span class="ruby-identifier">to_f</span>)
  <span class="ruby-identifier">clear_builder</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">last_builder</span>.<span class="ruby-identifier">ignored?</span>

  <span class="ruby-ivar">@samples_lock</span>.<span class="ruby-identifier">synchronize</span> <span class="ruby-keyword">do</span>
    <span class="ruby-comment"># NB this instance variable may be used elsewhere, it's not</span>
    <span class="ruby-comment"># just a side effect</span>
    <span class="ruby-ivar">@last_sample</span> = <span class="ruby-identifier">last_builder</span>.<span class="ruby-identifier">sample</span>
    <span class="ruby-identifier">store_sample</span>(<span class="ruby-ivar">@last_sample</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- notice_scope_empty-source -->
          
        </div>

        

        
      </div><!-- notice_scope_empty-method -->

    
      <div id="method-i-notice_sql" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">notice_sql</span><span
            class="method-args">(sql, config, duration)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>some statements (particularly INSERTS with large BLOBS may be very large;
we should trim them to a maximum usable length config is the driver
configuration for the connection duration is seconds, float value.</p>
          

          
          <div class="method-source-code" id="notice_sql-source">
            <pre><span class="ruby-comment"># File lib/new_relic/agent/transaction_sampler.rb, line 314</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">notice_sql</span>(<span class="ruby-identifier">sql</span>, <span class="ruby-identifier">config</span>, <span class="ruby-identifier">duration</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Agent</span>.<span class="ruby-identifier">is_sql_recorded?</span>
    <span class="ruby-identifier">notice_extra_data</span>(<span class="ruby-identifier">sql</span>, <span class="ruby-identifier">duration</span>, <span class="ruby-value">:sql</span>, <span class="ruby-identifier">config</span>, <span class="ruby-value">:connection_config</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- notice_sql-source -->
          
        </div>

        

        
      </div><!-- notice_sql-method -->

    
      <div id="method-i-notice_transaction" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">notice_transaction</span><span
            class="method-args">(path, uri=nil, params={})</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Delegates to the builder to store the path, uri, and parameters if the
sampler is active</p>
          

          
          <div class="method-source-code" id="notice_transaction-source">
            <pre><span class="ruby-comment"># File lib/new_relic/agent/transaction_sampler.rb, line 243</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">notice_transaction</span>(<span class="ruby-identifier">path</span>, <span class="ruby-identifier">uri</span>=<span class="ruby-keyword">nil</span>, <span class="ruby-identifier">params</span>={})
  <span class="ruby-identifier">builder</span>.<span class="ruby-identifier">set_transaction_info</span>(<span class="ruby-identifier">path</span>, <span class="ruby-identifier">uri</span>, <span class="ruby-identifier">params</span>) <span class="ruby-keyword">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">disabled</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">builder</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- notice_transaction-source -->
          
        </div>

        

        
      </div><!-- notice_transaction-method -->

    
      <div id="method-i-notice_transaction_cpu_time" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">notice_transaction_cpu_time</span><span
            class="method-args">(cpu_time)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Sets the CPU time used by a transaction, delegates to the builder</p>
          

          
          <div class="method-source-code" id="notice_transaction_cpu_time-source">
            <pre><span class="ruby-comment"># File lib/new_relic/agent/transaction_sampler.rb, line 261</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">notice_transaction_cpu_time</span>(<span class="ruby-identifier">cpu_time</span>)
  <span class="ruby-identifier">builder</span>.<span class="ruby-identifier">set_transaction_cpu_time</span>(<span class="ruby-identifier">cpu_time</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">builder</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- notice_transaction_cpu_time-source -->
          
        </div>

        

        
      </div><!-- notice_transaction_cpu_time-method -->

    
      <div id="method-i-reset-21" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">reset!</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>reset samples without rebooting the web server</p>
          

          
          <div class="method-source-code" id="reset-21-source">
            <pre><span class="ruby-comment"># File lib/new_relic/agent/transaction_sampler.rb, line 421</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">reset!</span>
  <span class="ruby-ivar">@samples</span> = []
  <span class="ruby-ivar">@last_sample</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-ivar">@random_sample</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-ivar">@slowest_sample</span> = <span class="ruby-keyword">nil</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- reset-21-source -->
          
        </div>

        

        
      </div><!-- reset-21-method -->

    
      <div id="method-i-sampling_rate-3D" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">sampling_rate=</span><span
            class="method-args">(val)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Set with an integer value n, this takes one in every n harvested samples.
It also resets the harvest count to a random integer between 0 and (n-1)</p>
          

          
          <div class="method-source-code" id="sampling_rate-3D-source">
            <pre><span class="ruby-comment"># File lib/new_relic/agent/transaction_sampler.rb, line 92</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">sampling_rate=</span>(<span class="ruby-identifier">val</span>)
  <span class="ruby-ivar">@sampling_rate</span> = <span class="ruby-identifier">val</span>.<span class="ruby-identifier">to_i</span>
  <span class="ruby-ivar">@harvest_count</span> = <span class="ruby-identifier">rand</span>(<span class="ruby-identifier">val</span>.<span class="ruby-identifier">to_i</span>).<span class="ruby-identifier">to_i</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- sampling_rate-3D-source -->
          
        </div>

        

        
      </div><!-- sampling_rate-3D-method -->

    
      <div id="method-i-scope_depth" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">scope_depth</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Defaults to zero, otherwise delegated to the transaction sample builder</p>
          

          
          <div class="method-source-code" id="scope_depth-source">
            <pre><span class="ruby-comment"># File lib/new_relic/agent/transaction_sampler.rb, line 139</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">scope_depth</span>
  <span class="ruby-keyword">return</span> <span class="ruby-value">0</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">builder</span>

  <span class="ruby-identifier">builder</span>.<span class="ruby-identifier">scope_depth</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- scope_depth-source -->
          
        </div>

        

        
      </div><!-- scope_depth-method -->

    
      <div id="method-i-slowest_sample-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">slowest_sample?</span><span
            class="method-args">(old_sample, new_sample)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Checks to see if the old sample exists, or if it’s duration is less than
the new sample</p>
          

          
          <div class="method-source-code" id="slowest_sample-3F-source">
            <pre><span class="ruby-comment"># File lib/new_relic/agent/transaction_sampler.rb, line 229</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">slowest_sample?</span>(<span class="ruby-identifier">old_sample</span>, <span class="ruby-identifier">new_sample</span>)
  <span class="ruby-identifier">old_sample</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> (<span class="ruby-identifier">new_sample</span>.<span class="ruby-identifier">duration</span> <span class="ruby-operator">&gt;</span> <span class="ruby-identifier">old_sample</span>.<span class="ruby-identifier">duration</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- slowest_sample-3F-source -->
          
        </div>

        

        
      </div><!-- slowest_sample-3F-method -->

    
      <div id="method-i-start_builder" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">start_builder</span><span
            class="method-args">(time=nil)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Checks to see if the transaction sampler is disabled, if transaction trace
recording is disabled by a thread local, or if execution is untraced - if
so it clears the transaction sample builder from the thread local,
otherwise it generates a new transaction sample builder with the stated
time as a starting point and saves it in the thread local variable</p>
          

          
          <div class="method-source-code" id="start_builder-source">
            <pre><span class="ruby-comment"># File lib/new_relic/agent/transaction_sampler.rb, line 434</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">start_builder</span>(<span class="ruby-identifier">time</span>=<span class="ruby-keyword">nil</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">disabled</span> <span class="ruby-operator">||</span> <span class="ruby-operator">!</span><span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Agent</span>.<span class="ruby-identifier">is_transaction_traced?</span> <span class="ruby-operator">||</span> <span class="ruby-operator">!</span><span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Agent</span>.<span class="ruby-identifier">is_execution_traced?</span>
    <span class="ruby-identifier">clear_builder</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-constant">Thread</span><span class="ruby-operator">::</span><span class="ruby-identifier">current</span>[<span class="ruby-constant">BUILDER_KEY</span>] <span class="ruby-operator">||=</span> <span class="ruby-constant">TransactionSampleBuilder</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">time</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- start_builder-source -->
          
        </div>

        

        
      </div><!-- start_builder-method -->

    
      <div id="method-i-store_force_persist" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">store_force_persist</span><span
            class="method-args">(sample)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="store_force_persist-source">
            <pre><span class="ruby-comment"># File lib/new_relic/agent/transaction_sampler.rb, line 200</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">store_force_persist</span>(<span class="ruby-identifier">sample</span>)
  <span class="ruby-ivar">@force_persist</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">sample</span>

  <span class="ruby-comment"># WARNING - this clamp should be configurable</span>
  <span class="ruby-keyword">if</span> <span class="ruby-ivar">@force_persist</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">15</span>
    <span class="ruby-ivar">@force_persist</span>.<span class="ruby-identifier">sort!</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">a</span>,<span class="ruby-identifier">b</span><span class="ruby-operator">|</span> <span class="ruby-identifier">b</span>.<span class="ruby-identifier">duration</span> <span class="ruby-operator">&lt;=&gt;</span> <span class="ruby-identifier">a</span>.<span class="ruby-identifier">duration</span>}
    <span class="ruby-ivar">@force_persist</span> = <span class="ruby-ivar">@force_persist</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">14</span>]
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- store_force_persist-source -->
          
        </div>

        

        
      </div><!-- store_force_persist-method -->

    
      <div id="method-i-store_random_sample" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">store_random_sample</span><span
            class="method-args">(sample)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Only active when random sampling is true - this is very rarely used. Always
store the most recent sample so that random sampling can pick a few of the
samples to store, upon harvest</p>
          

          
          <div class="method-source-code" id="store_random_sample-source">
            <pre><span class="ruby-comment"># File lib/new_relic/agent/transaction_sampler.rb, line 194</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">store_random_sample</span>(<span class="ruby-identifier">sample</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-ivar">@random_sampling</span>
    <span class="ruby-ivar">@random_sample</span> = <span class="ruby-identifier">sample</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- store_random_sample-source -->
          
        </div>

        

        
      </div><!-- store_random_sample-method -->

    
      <div id="method-i-store_sample" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">store_sample</span><span
            class="method-args">(sample)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Samples can be stored in three places: the random sample variable, when
random sampling is active, the developer mode @samples array, and the
@slowest_sample variable if it is slower than the current occupant of that
slot</p>
          

          
          <div class="method-source-code" id="store_sample-source">
            <pre><span class="ruby-comment"># File lib/new_relic/agent/transaction_sampler.rb, line 181</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">store_sample</span>(<span class="ruby-identifier">sample</span>)
  <span class="ruby-identifier">store_random_sample</span>(<span class="ruby-identifier">sample</span>)
  <span class="ruby-identifier">store_sample_for_developer_mode</span>(<span class="ruby-identifier">sample</span>)
  <span class="ruby-identifier">store_slowest_sample</span>(<span class="ruby-identifier">sample</span>)
  
  <span class="ruby-keyword">if</span> <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Agent</span><span class="ruby-operator">::</span><span class="ruby-constant">TransactionInfo</span>.<span class="ruby-identifier">get</span>.<span class="ruby-identifier">force_persist_sample?</span>(<span class="ruby-identifier">sample</span>)
    <span class="ruby-identifier">store_force_persist</span>(<span class="ruby-identifier">sample</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- store_sample-source -->
          
        </div>

        

        
      </div><!-- store_sample-method -->

    
      <div id="method-i-store_sample_for_developer_mode" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">store_sample_for_developer_mode</span><span
            class="method-args">(sample)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Samples take up a ton of memory, so we only store a lot of them in
developer mode - we truncate to @max_samples</p>
          

          
          <div class="method-source-code" id="store_sample_for_developer_mode-source">
            <pre><span class="ruby-comment"># File lib/new_relic/agent/transaction_sampler.rb, line 212</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">store_sample_for_developer_mode</span>(<span class="ruby-identifier">sample</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">unless</span> <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Control</span>.<span class="ruby-identifier">instance</span>.<span class="ruby-identifier">developer_mode?</span>
  <span class="ruby-ivar">@samples</span> = [] <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@samples</span>
  <span class="ruby-ivar">@samples</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">sample</span>
  <span class="ruby-identifier">truncate_samples</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- store_sample_for_developer_mode-source -->
          
        </div>

        

        
      </div><!-- store_sample_for_developer_mode-method -->

    
      <div id="method-i-store_slowest_sample" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">store_slowest_sample</span><span
            class="method-args">(sample)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Sets @slowest_sample to the passed in sample if it is slower than the
current sample in @slowest_sample</p>
          

          
          <div class="method-source-code" id="store_slowest_sample-source">
            <pre><span class="ruby-comment"># File lib/new_relic/agent/transaction_sampler.rb, line 221</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">store_slowest_sample</span>(<span class="ruby-identifier">sample</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">slowest_sample?</span>(<span class="ruby-ivar">@slowest_sample</span>, <span class="ruby-identifier">sample</span>)
    <span class="ruby-ivar">@slowest_sample</span> = <span class="ruby-identifier">sample</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- store_slowest_sample-source -->
          
        </div>

        

        
      </div><!-- store_slowest_sample-method -->

    
      <div id="method-i-truncate_message" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">truncate_message</span><span
            class="method-args">(message)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Truncates the message to `<a
href="TransactionSampler.html#MAX_DATA_LENGTH">MAX_DATA_LENGTH</a>` if
needed, and appends an ellipsis because it makes the trucation clearer in
the UI</p>
          

          
          <div class="method-source-code" id="truncate_message-source">
            <pre><span class="ruby-comment"># File lib/new_relic/agent/transaction_sampler.rb, line 286</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">truncate_message</span>(<span class="ruby-identifier">message</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">message</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> (<span class="ruby-constant">MAX_DATA_LENGTH</span> <span class="ruby-operator">-</span> <span class="ruby-value">4</span>)
    <span class="ruby-identifier">message</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-constant">MAX_DATA_LENGTH</span> <span class="ruby-operator">-</span> <span class="ruby-value">4</span>] <span class="ruby-operator">+</span> <span class="ruby-string">'...'</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">message</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- truncate_message-source -->
          
        </div>

        

        
      </div><!-- truncate_message-method -->

    
      <div id="method-i-truncate_samples" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">truncate_samples</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Smashes the @samples array down to the length of @max_samples by taking the
last @max_samples elements of the array</p>
          

          
          <div class="method-source-code" id="truncate_samples-source">
            <pre><span class="ruby-comment"># File lib/new_relic/agent/transaction_sampler.rb, line 235</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">truncate_samples</span>
  <span class="ruby-keyword">if</span> <span class="ruby-ivar">@samples</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@max_samples</span>
    <span class="ruby-ivar">@samples</span> = <span class="ruby-ivar">@samples</span>[<span class="ruby-operator">-</span><span class="ruby-ivar">@max_samples</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>]
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- truncate_samples-source -->
          
        </div>

        

        
      </div><!-- truncate_samples-method -->

    
    </section><!-- public-instance-method-details -->
  
  </section><!-- 5Buntitled-5D -->

</div><!-- documentation -->


<footer id="validator-badges">
  <p><a href="http://validator.w3.org/check/referer">[Validate]</a>
  <p>Generated by <a href="https://github.com/rdoc/rdoc">RDoc</a> 3.11.
  <p>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish Rdoc Generator</a> 3.
</footer>

