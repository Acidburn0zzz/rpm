<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>NewRelic::Agent::StatsEngine::Transactions</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" href="../../../../css/reset.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="../../../../css/main.css" type="text/css" media="screen" />
    <script src="../../../../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../../../js/jquery-effect.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../../../js/main.js" type="text/javascript" charset="utf-8"></script>
</head>

<body>     
    <div class="banner">
        <h1>
            <span class="type">Module</span> 
            NewRelic::Agent::StatsEngine::Transactions 
            
        </h1>
        <ul class="files">
            
            <li><a href="../../../../files/lib/new_relic/agent/stats_engine/transactions_rb.html">lib/new_relic/agent/stats_engine/transactions.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
    

    

    
    

    
    
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
    
        <dt>E</dt>
        <dd>
            <ul>
                
                <li><a href="#M000892">end_transaction</a></li>
                
            </ul>
        </dd>
    
        <dt>P</dt>
        <dd>
            <ul>
                
                <li><a href="#M000888">peek_scope</a>,</li>
                
                <li><a href="#M000887">pop_scope</a>,</li>
                
                <li><a href="#M000884">push_scope</a></li>
                
            </ul>
        </dd>
    
        <dt>R</dt>
        <dd>
            <ul>
                
                <li><a href="#M000883">remove_transaction_sampler</a></li>
                
            </ul>
        </dd>
    
        <dt>S</dt>
        <dd>
            <ul>
                
                <li><a href="#M000890">scope_name</a>,</li>
                
                <li><a href="#M000889">scope_name=</a>,</li>
                
                <li><a href="#M000891">start_transaction</a></li>
                
            </ul>
        </dd>
    
        <dt>T</dt>
        <dd>
            <ul>
                
                <li><a href="#M000882">transaction_sampler=</a></li>
                
            </ul>
        </dd>
    
    </dl>
    

    

    

    
    <div class="sectiontitle">Classes and Modules</div>
    <ul>
        
        <li><span class="type">MODULE</span> <a href="Transactions/Shim.html">NewRelic::Agent::StatsEngine::Transactions::Shim</a></li>
        
    </ul>
    

    

    

    
            <div class="sectiontitle">Instance Public methods</div>
            
            <div class="method">
                <div class="title" id="M000892">
                    
                    <a name="M000892"></a><b>end_transaction</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Try to clean up gracefully, otherwise we leave things hanging around on
thread locals. If it looks like a transaction is still in progress, then
maybe this is an inner transaction and is ignored.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000892_source')" id="l_M000892_source">show</a>
                        
                    </p>
                    <div id="M000892_source" class="dyn-source">
                        <pre><span class="ruby-comment cmt"># File lib/new_relic/agent/stats_engine/transactions.rb, line 103</span>
      <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">end_transaction</span>
        <span class="ruby-identifier">stack</span> = <span class="ruby-identifier">scope_stack</span>
        
        <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">stack</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">stack</span>.<span class="ruby-identifier">empty?</span>
          <span class="ruby-constant">Thread</span><span class="ruby-operator">::</span><span class="ruby-identifier">current</span>[<span class="ruby-identifier">:newrelic_scope_stack</span>] = <span class="ruby-keyword kw">nil</span>
          <span class="ruby-constant">Thread</span><span class="ruby-operator">::</span><span class="ruby-identifier">current</span>[<span class="ruby-identifier">:newrelic_scope_name</span>] = <span class="ruby-keyword kw">nil</span>
        <span class="ruby-keyword kw">end</span>
      <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000888">
                    
                    <a name="M000888"></a><b>peek_scope</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000888_source')" id="l_M000888_source">show</a>
                        
                    </p>
                    <div id="M000888_source" class="dyn-source">
                        <pre><span class="ruby-comment cmt"># File lib/new_relic/agent/stats_engine/transactions.rb, line 73</span>
      <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">peek_scope</span>
        <span class="ruby-identifier">scope_stack</span>.<span class="ruby-identifier">last</span>
      <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000887">
                    
                    <a name="M000887"></a><b>pop_scope</b>(expected_scope, duration, time=Time.now.to_f)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000887_source')" id="l_M000887_source">show</a>
                        
                    </p>
                    <div id="M000887_source" class="dyn-source">
                        <pre><span class="ruby-comment cmt"># File lib/new_relic/agent/stats_engine/transactions.rb, line 56</span>
      <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">pop_scope</span>(<span class="ruby-identifier">expected_scope</span>, <span class="ruby-identifier">duration</span>, <span class="ruby-identifier">time</span>=<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">to_f</span>)
        <span class="ruby-identifier">capture_gc_time</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">collecting_gc?</span>
        <span class="ruby-identifier">stack</span> = <span class="ruby-identifier">scope_stack</span>
        <span class="ruby-identifier">scope</span> = <span class="ruby-identifier">stack</span>.<span class="ruby-identifier">pop</span>
        <span class="ruby-identifier">fail</span> <span class="ruby-node">&quot;unbalanced pop from blame stack, got #{scope ? scope.name : 'nil'}, expected #{expected_scope ? expected_scope.name : 'nil'}&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">scope</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">expected_scope</span>
        
        <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">stack</span>.<span class="ruby-identifier">empty?</span> 
          <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">deduct_call_time_from_parent</span>
            <span class="ruby-identifier">stack</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">children_time</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">duration</span>
          <span class="ruby-keyword kw">else</span>
            <span class="ruby-identifier">stack</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">children_time</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">scope</span>.<span class="ruby-identifier">children_time</span>
          <span class="ruby-keyword kw">end</span>
        <span class="ruby-keyword kw">end</span>
        <span class="ruby-ivar">@transaction_sampler</span>.<span class="ruby-identifier">notice_pop_scope</span>(<span class="ruby-identifier">scope</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">time</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@transaction_sampler</span>
        <span class="ruby-identifier">scope</span>
      <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000884">
                    
                    <a name="M000884"></a><b>push_scope</b>(metric, time = Time.now.to_f, deduct_call_time_from_parent = true)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000884_source')" id="l_M000884_source">show</a>
                        
                    </p>
                    <div id="M000884_source" class="dyn-source">
                        <pre><span class="ruby-comment cmt"># File lib/new_relic/agent/stats_engine/transactions.rb, line 38</span>
      <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">push_scope</span>(<span class="ruby-identifier">metric</span>, <span class="ruby-identifier">time</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">to_f</span>, <span class="ruby-identifier">deduct_call_time_from_parent</span> = <span class="ruby-keyword kw">true</span>)
        
        <span class="ruby-identifier">stack</span> = <span class="ruby-identifier">scope_stack</span>
        <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">collecting_gc?</span>
          <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">stack</span>.<span class="ruby-identifier">empty?</span>
            <span class="ruby-comment cmt"># reset the gc time so we only include gc time spent during this call</span>
            <span class="ruby-ivar">@last_gc_timestamp</span> = <span class="ruby-constant">GC</span>.<span class="ruby-identifier">time</span>
            <span class="ruby-ivar">@last_gc_count</span> = <span class="ruby-constant">GC</span>.<span class="ruby-identifier">collections</span>
          <span class="ruby-keyword kw">else</span>
            <span class="ruby-identifier">capture_gc_time</span>
          <span class="ruby-keyword kw">end</span>
        <span class="ruby-keyword kw">end</span>
        <span class="ruby-ivar">@transaction_sampler</span>.<span class="ruby-identifier">notice_push_scope</span> <span class="ruby-identifier">metric</span>, <span class="ruby-identifier">time</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@transaction_sampler</span>
        <span class="ruby-identifier">scope</span> = <span class="ruby-constant">ScopeStackElement</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">metric</span>, <span class="ruby-identifier">deduct_call_time_from_parent</span>)
        <span class="ruby-identifier">stack</span>.<span class="ruby-identifier">push</span> <span class="ruby-identifier">scope</span>
        <span class="ruby-identifier">scope</span>
      <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000883">
                    
                    <a name="M000883"></a><b>remove_transaction_sampler</b>(l)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000883_source')" id="l_M000883_source">show</a>
                        
                    </p>
                    <div id="M000883_source" class="dyn-source">
                        <pre><span class="ruby-comment cmt"># File lib/new_relic/agent/stats_engine/transactions.rb, line 34</span>
      <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">remove_transaction_sampler</span>(<span class="ruby-identifier">l</span>)
        <span class="ruby-ivar">@transaction_sampler</span> = <span class="ruby-keyword kw">nil</span>
      <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000890">
                    
                    <a name="M000890"></a><b>scope_name</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000890_source')" id="l_M000890_source">show</a>
                        
                    </p>
                    <div id="M000890_source" class="dyn-source">
                        <pre><span class="ruby-comment cmt"># File lib/new_relic/agent/stats_engine/transactions.rb, line 89</span>
      <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">scope_name</span>
        <span class="ruby-constant">Thread</span><span class="ruby-operator">::</span><span class="ruby-identifier">current</span>[<span class="ruby-identifier">:newrelic_scope_name</span>]
      <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000889">
                    
                    <a name="M000889"></a><b>scope_name=</b>(transaction)
                    
                </div>
                
                <div class="description">
                  <p>
set the name of the transaction for the current thread, which will be used
to define the scope of all traced methods called on this thread until the
scope stack is empty.
</p>
<p>
currently the transaction name is the name of the controller action that is
invoked via the dispatcher, but conceivably we could use other transaction
names in the future if the traced application does more than service http
request via controller actions
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000889_source')" id="l_M000889_source">show</a>
                        
                    </p>
                    <div id="M000889_source" class="dyn-source">
                        <pre><span class="ruby-comment cmt"># File lib/new_relic/agent/stats_engine/transactions.rb, line 85</span>
      <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">scope_name=</span>(<span class="ruby-identifier">transaction</span>)
        <span class="ruby-constant">Thread</span><span class="ruby-operator">::</span><span class="ruby-identifier">current</span>[<span class="ruby-identifier">:newrelic_scope_name</span>] = <span class="ruby-identifier">transaction</span>
      <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000891">
                    
                    <a name="M000891"></a><b>start_transaction</b>(name = nil)
                    
                </div>
                
                <div class="description">
                  <p>
Start a new transaction, unless one is already in progress
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000891_source')" id="l_M000891_source">show</a>
                        
                    </p>
                    <div id="M000891_source" class="dyn-source">
                        <pre><span class="ruby-comment cmt"># File lib/new_relic/agent/stats_engine/transactions.rb, line 94</span>
      <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">start_transaction</span>(<span class="ruby-identifier">name</span> = <span class="ruby-keyword kw">nil</span>)
        <span class="ruby-constant">Thread</span><span class="ruby-operator">::</span><span class="ruby-identifier">current</span>[<span class="ruby-identifier">:newrelic_scope_stack</span>] <span class="ruby-operator">||=</span> []
        <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">scope_name</span> = <span class="ruby-identifier">name</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">name</span>
      <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000882">
                    
                    <a name="M000882"></a><b>transaction_sampler=</b>(sampler)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000882_source')" id="l_M000882_source">show</a>
                        
                    </p>
                    <div id="M000882_source" class="dyn-source">
                        <pre><span class="ruby-comment cmt"># File lib/new_relic/agent/stats_engine/transactions.rb, line 29</span>
      <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">transaction_sampler=</span> <span class="ruby-identifier">sampler</span>
        <span class="ruby-identifier">fail</span> <span class="ruby-value str">&quot;Can't add a scope listener midflight in a transaction&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">scope_stack</span>.<span class="ruby-identifier">any?</span>
        <span class="ruby-ivar">@transaction_sampler</span> = <span class="ruby-identifier">sampler</span>
      <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
</div>
    </div>
  </body>
</html>    