<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>NewRelic::Agent::BusyCalculator</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" href="../../../css/reset.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="../../../css/main.css" type="text/css" media="screen" />
    <script src="../../../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../../js/jquery-effect.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../../js/main.js" type="text/javascript" charset="utf-8"></script>
</head>

<body>     
    <div class="banner">
        <h1>
            <span class="type">Module</span> 
            NewRelic::Agent::BusyCalculator 
            
        </h1>
        <ul class="files">
            
            <li><a href="../../../files/lib/new_relic/agent/busy_calculator_rb.html">lib/new_relic/agent/busy_calculator.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
    
    <div class="description">
        <p>
This module supports calculation of actual time spent processing requests
over the course of one harvest period. It&#8217;s similar to what you would
get if you just added up all the execution times of controller calls,
however that will be inaccurate when requests span the minute boundaries.
This module manages accounting of requests not yet completed.
</p>
<p>
Calls are re-entrant. All start calls must be paired with finish calls, or
a reset call.
</p>

    </div>
    

    

    
    

    
    
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
    
        <dt>B</dt>
        <dd>
            <ul>
                
                <li><a href="#M000052">busy_count</a></li>
                
            </ul>
        </dd>
    
        <dt>D</dt>
        <dd>
            <ul>
                
                <li><a href="#M000045">dispatcher_finish</a>,</li>
                
                <li><a href="#M000044">dispatcher_start</a></li>
                
            </ul>
        </dd>
    
        <dt>H</dt>
        <dd>
            <ul>
                
                <li><a href="#M000059">harvest_busy</a></li>
                
            </ul>
        </dd>
    
        <dt>R</dt>
        <dd>
            <ul>
                
                <li><a href="#M000053">reset</a></li>
                
            </ul>
        </dd>
    
    </dl>
    

    

    

    

    

    
    <div class="sectiontitle">Attributes</div>
    <table border='0' cellpadding='5'>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [R]
            </td>
            <td class='attr-name'>harvest_start</td>
            <td class='attr-desc'><p>
For testability, add accessors:
</p></td>
        </tr>
        
        <tr valign='top'>
            <td class='attr-rw'>
                [R]
            </td>
            <td class='attr-name'>accumulator</td>
            <td class='attr-desc'><p>
For testability, add accessors:
</p></td>
        </tr>
        
    </table>
    

    
            <div class="sectiontitle">Instance Public methods</div>
            
            <div class="method">
                <div class="title" id="M000052">
                    
                    <a name="M000052"></a><b>busy_count</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000052_source')" id="l_M000052_source">show</a>
                        
                    </p>
                    <div id="M000052_source" class="dyn-source">
                        <pre><span class="ruby-comment cmt"># File lib/new_relic/agent/busy_calculator.rb, line 40</span>
      <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">busy_count</span>
        <span class="ruby-ivar">@entrypoint_stack</span>.<span class="ruby-identifier">size</span>
      <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000045">
                    
                    <a name="M000045"></a><b>dispatcher_finish</b>(end_time = Time.now)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000045_source')" id="l_M000045_source">show</a>
                        
                    </p>
                    <div id="M000045_source" class="dyn-source">
                        <pre><span class="ruby-comment cmt"># File lib/new_relic/agent/busy_calculator.rb, line 27</span>
      <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">dispatcher_finish</span>(<span class="ruby-identifier">end_time</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>)
        <span class="ruby-identifier">callers</span> = <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">current</span>[<span class="ruby-identifier">:busy_entries</span>] <span class="ruby-operator">-=</span> <span class="ruby-value">1</span>
        <span class="ruby-comment cmt"># Ignore nested calls</span>
        <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">callers</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
        <span class="ruby-ivar">@lock</span>.<span class="ruby-identifier">synchronize</span> <span class="ruby-keyword kw">do</span>
          <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@entrypoint_stack</span>.<span class="ruby-identifier">empty?</span>
            <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Agent</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">error</span>(<span class="ruby-node">&quot;Stack underflow tracking dispatcher entry and exit!\n  #{caller.join(&quot;  \n&quot;)}&quot;</span>)
          <span class="ruby-keyword kw">else</span>
            <span class="ruby-ivar">@accumulator</span> <span class="ruby-operator">+=</span> (<span class="ruby-identifier">end_time</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@entrypoint_stack</span>.<span class="ruby-identifier">pop</span>).<span class="ruby-identifier">to_f</span>
          <span class="ruby-keyword kw">end</span>
        <span class="ruby-keyword kw">end</span>
      <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000044">
                    
                    <a name="M000044"></a><b>dispatcher_start</b>(time)
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000044_source')" id="l_M000044_source">show</a>
                        
                    </p>
                    <div id="M000044_source" class="dyn-source">
                        <pre><span class="ruby-comment cmt"># File lib/new_relic/agent/busy_calculator.rb, line 18</span>
      <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">dispatcher_start</span>(<span class="ruby-identifier">time</span>)
        <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">current</span>[<span class="ruby-identifier">:busy_entries</span>] <span class="ruby-operator">||=</span> <span class="ruby-value">0</span>
        <span class="ruby-identifier">callers</span> = <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">current</span>[<span class="ruby-identifier">:busy_entries</span>] <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
        <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">callers</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>
        <span class="ruby-ivar">@lock</span>.<span class="ruby-identifier">synchronize</span> <span class="ruby-keyword kw">do</span>
          <span class="ruby-ivar">@entrypoint_stack</span>.<span class="ruby-identifier">push</span> <span class="ruby-identifier">time</span>
        <span class="ruby-keyword kw">end</span>
      <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000059">
                    
                    <a name="M000059"></a><b>harvest_busy</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Called before uploading to to the server to collect current busy stats.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000059_source')" id="l_M000059_source">show</a>
                        
                    </p>
                    <div id="M000059_source" class="dyn-source">
                        <pre><span class="ruby-comment cmt"># File lib/new_relic/agent/busy_calculator.rb, line 57</span>
      <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">harvest_busy</span>
        <span class="ruby-identifier">busy</span> = <span class="ruby-value">0</span>
        <span class="ruby-identifier">t0</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
        <span class="ruby-ivar">@lock</span>.<span class="ruby-identifier">synchronize</span> <span class="ruby-keyword kw">do</span>
          <span class="ruby-identifier">busy</span> = <span class="ruby-identifier">accumulator</span>
          <span class="ruby-ivar">@accumulator</span> = <span class="ruby-value">0</span>

          <span class="ruby-comment cmt"># Walk through the stack and capture all times up to</span>
          <span class="ruby-comment cmt"># now for entrypoints</span>
          <span class="ruby-ivar">@entrypoint_stack</span>.<span class="ruby-identifier">size</span>.<span class="ruby-identifier">times</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">frame</span><span class="ruby-operator">|</span>
            <span class="ruby-identifier">busy</span> <span class="ruby-operator">+=</span> (<span class="ruby-identifier">t0</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@entrypoint_stack</span>[<span class="ruby-identifier">frame</span>]).<span class="ruby-identifier">to_f</span>
            <span class="ruby-ivar">@entrypoint_stack</span>[<span class="ruby-identifier">frame</span>] = <span class="ruby-identifier">t0</span>
          <span class="ruby-keyword kw">end</span>

        <span class="ruby-keyword kw">end</span>

        <span class="ruby-identifier">busy</span> = <span class="ruby-value">0</span><span class="ruby-value">.0</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">busy</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">0</span><span class="ruby-value">.0</span> <span class="ruby-comment cmt"># don't go below 0%</span>

        <span class="ruby-identifier">time_window</span> = (<span class="ruby-identifier">t0</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">harvest_start</span>).<span class="ruby-identifier">to_f</span>
        <span class="ruby-identifier">time_window</span> = <span class="ruby-value">1.0</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">time_window</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span><span class="ruby-value">.0</span>  <span class="ruby-comment cmt"># protect against divide by zero</span>

        <span class="ruby-identifier">busy</span> = <span class="ruby-identifier">busy</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">time_window</span>

        <span class="ruby-identifier">instance_busy_stats</span>.<span class="ruby-identifier">record_data_point</span> <span class="ruby-identifier">busy</span>
        <span class="ruby-ivar">@harvest_start</span> = <span class="ruby-identifier">t0</span>
      <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000053">
                    
                    <a name="M000053"></a><b>reset</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Reset the state of the information accumulated by all threads, but only
reset the recursion counter for this thread.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000053_source')" id="l_M000053_source">show</a>
                        
                    </p>
                    <div id="M000053_source" class="dyn-source">
                        <pre><span class="ruby-comment cmt"># File lib/new_relic/agent/busy_calculator.rb, line 46</span>
      <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">reset</span>
        <span class="ruby-ivar">@entrypoint_stack</span> = []
        <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">current</span>[<span class="ruby-identifier">:busy_entries</span>] = <span class="ruby-value">0</span>
        <span class="ruby-ivar">@lock</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">Mutex</span>.<span class="ruby-identifier">new</span>
        <span class="ruby-ivar">@accumulator</span> = <span class="ruby-value">0</span>
        <span class="ruby-ivar">@harvest_start</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>
      <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
</div>
    </div>
  </body>
</html>    