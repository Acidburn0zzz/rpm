<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>NewRelic::Agent::Instrumentation::ControllerInstrumentation</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link rel="stylesheet" href="../../../../css/reset.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="../../../../css/main.css" type="text/css" media="screen" />
    <script src="../../../../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../../../js/jquery-effect.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../../../js/main.js" type="text/javascript" charset="utf-8"></script>
</head>

<body>     
    <div class="banner">
        <h1>
            <span class="type">Module</span> 
            NewRelic::Agent::Instrumentation::ControllerInstrumentation 
            
        </h1>
        <ul class="files">
            
            <li><a href="../../../../files/lib/new_relic/agent/instrumentation/controller_instrumentation_rb.html">lib/new_relic/agent/instrumentation/controller_instrumentation.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
    
    <div class="description">
        <h2>NewRelic instrumentation for controller actions and tasks</h2>
<p>
This instrumentation is applied to the action controller to collect metrics
for every web request.
</p>
<p>
It can also be used to capture performance information for background tasks
and other non-web transactions, including detailed transaction traces and
traced errors.
</p>
<p>
For details on how to instrument background tasks see <a
href="ControllerInstrumentation/ClassMethods.html#M000945">ClassMethods#add_transaction_tracer</a>
and <a
href="ControllerInstrumentation.html#M000949">perform_action_with_newrelic_trace</a>
</p>

    </div>
    

    

    
    

    
    
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
    
        <dt>N</dt>
        <dd>
            <ul>
                
                <li><a href="#M000951">newrelic_request_headers</a>,</li>
                
                <li><a href="#M000950">newrelic_response_code</a></li>
                
            </ul>
        </dd>
    
        <dt>P</dt>
        <dd>
            <ul>
                
                <li><a href="#M000949">perform_action_with_newrelic_trace</a></li>
                
            </ul>
        </dd>
    
    </dl>
    

    
    <div class="sectiontitle">Included Modules</div>
    <ul>
        
        <li>
            
            <a href="../../DelayedJobInjection.html">NewRelic::DelayedJobInjection</a>
            
            START:includes
        </li>
        
    </ul>
    

    

    
    <div class="sectiontitle">Classes and Modules</div>
    <ul>
        
        <li><span class="type">MODULE</span> <a href="ControllerInstrumentation/ClassMethods.html">NewRelic::Agent::Instrumentation::ControllerInstrumentation::ClassMethods</a></li>
        
        <li><span class="type">MODULE</span> <a href="ControllerInstrumentation/ClassMethodsShim.html">NewRelic::Agent::Instrumentation::ControllerInstrumentation::ClassMethodsShim</a></li>
        
        <li><span class="type">MODULE</span> <a href="ControllerInstrumentation/Shim.html">NewRelic::Agent::Instrumentation::ControllerInstrumentation::Shim</a></li>
        
    </ul>
    

    

    

    
            <div class="sectiontitle">Instance Public methods</div>
            
            <div class="method">
                <div class="title" id="M000949">
                    
                    <a name="M000949"></a><b>perform_action_with_newrelic_trace</b>(*args, &amp;block)
                    
                </div>
                
                <div class="description">
                  <p>
Yield to the given block with NewRelic tracing. Used by default
instrumentation on controller actions in Rails and Merb. But it can also be
used in custom instrumentation of controller methods and background tasks.
</p>
<p>
This is the method invoked by instrumentation added by the <tt><a
href="ControllerInstrumentation/ClassMethods.html#M000945">ClassMethods#add_transaction_tracer</a></tt>.
</p>
<p>
Here&#8217;s a more verbose version of the example shown in <tt><a
href="ControllerInstrumentation/ClassMethods.html#M000945">ClassMethods#add_transaction_tracer</a></tt>
using this method instead of add_transaction_tracer.
</p>
<p>
Below is a controller with an <tt>invoke_operation</tt> action which
dispatches to more specific operation methods based on a parameter (very
dangerous, btw!). With this instrumentation, the <tt>invoke_operation</tt>
action is ignored but the operation methods show up in RPM as if they were
first class controller actions
</p>
<pre>
  MyController &lt; ActionController::Base
    include NewRelic::Agent::Instrumentation::ControllerInstrumentation
    # dispatch the given op to the method given by the service parameter.
    def invoke_operation
      op = params['operation']
      perform_action_with_newrelic_trace(:name =&gt; op) do
        send op, params['message']
      end
    end
    # Ignore the invoker to avoid double counting
    newrelic_ignore :only =&gt; 'invoke_operation'
  end
</pre>
<p>
When invoking this method explicitly as in the example above, pass in a
block to measure with some combination of options:
</p>
<ul>
<li><tt>:category =&gt; :controller</tt> indicates that this is a controller
action and will appear with all the other actions. This is the default.

</li>
<li><tt>:category =&gt; :task</tt> indicates that this is a background task and
will show up in RPM with other background tasks instead of in the
controllers list

</li>
<li><tt>:category =&gt; :rack</tt> if you are instrumenting a rack middleware
call. The <tt>:name</tt> is optional, useful if you have more than one
potential transaction in the call.

</li>
<li><tt>:category =&gt; :uri</tt> indicates that this is a web transaction
whose name is a normalized URI, where &#8216;normalized&#8217; means the
URI does not have any elements with data in them such as in many REST URIs.

</li>
<li><tt>:name =&gt; action_name</tt> is used to specify the action name used as
part of the metric name

</li>
<li><tt>:params =&gt; {...}</tt> to provide information about the context of
the call, used in transaction trace display, for example: <tt>:params =&gt;
{ :account =&gt; @account.name, :file =&gt; file.name }</tt> These are
treated similarly to request parameters in web transactions.

</li>
</ul>
<p>
Seldomly used options:
</p>
<ul>
<li><tt>:force =&gt; true</tt> indicates you should capture all metrics even if
the newrelic_ignore directive was specified

</li>
<li><tt>:class_name =&gt; aClass.name</tt> is used to override the name of the
class when used inside the metric name. Default is the current class.

</li>
<li><tt>:path =&gt; metric_path</tt> is <b>deprecated</b> in the public API. It
allows you to set the entire metric after the category part. Overrides all
the other options.

</li>
<li><tt>:request =&gt; Rack::Request#new(env)</tt> is used to pass in a request
object that may respond to uri and referer.

</li>
</ul>
<p>
If a single argument is passed in, it is treated as a metric path. This
form is deprecated.
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000949_source')" id="l_M000949_source">show</a>
                        
                    </p>
                    <div id="M000949_source" class="dyn-source">
                        <pre><span class="ruby-comment cmt"># File lib/new_relic/agent/instrumentation/controller_instrumentation.rb, line 234</span>
        <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">perform_action_with_newrelic_trace</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)

          <span class="ruby-comment cmt"># Skip instrumentation based on the value of 'do_not_trace' and if</span>
          <span class="ruby-comment cmt"># we aren't calling directly with a block.</span>
          <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">block_given?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">_is_filtered?</span>(<span class="ruby-value str">'do_not_trace'</span>)
            <span class="ruby-comment cmt"># Also ignore all instrumentation in the call sequence</span>
            <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Agent</span>.<span class="ruby-identifier">disable_all_tracing</span> <span class="ruby-keyword kw">do</span>
              <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">perform_action_without_newrelic_trace</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>)
            <span class="ruby-keyword kw">end</span>
          <span class="ruby-keyword kw">end</span>

          <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">perform_action_with_newrelic_profile</span>(<span class="ruby-identifier">args</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Control</span>.<span class="ruby-identifier">instance</span>.<span class="ruby-identifier">profiling?</span>

          <span class="ruby-identifier">frame_data</span> = <span class="ruby-identifier">_push_metric_frame</span>(<span class="ruby-identifier">block_given?</span> <span class="ruby-value">? </span><span class="ruby-identifier">args</span> <span class="ruby-operator">:</span> [])
          <span class="ruby-keyword kw">begin</span>
            <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Agent</span>.<span class="ruby-identifier">trace_execution_scoped</span> <span class="ruby-identifier">frame_data</span>.<span class="ruby-identifier">recorded_metrics</span>, <span class="ruby-identifier">:force</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">frame_data</span>.<span class="ruby-identifier">force_flag</span> <span class="ruby-keyword kw">do</span>
              <span class="ruby-identifier">frame_data</span>.<span class="ruby-identifier">start_transaction</span>
              <span class="ruby-keyword kw">begin</span>
                <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Agent</span><span class="ruby-operator">::</span><span class="ruby-constant">BusyCalculator</span>.<span class="ruby-identifier">dispatcher_start</span> <span class="ruby-identifier">frame_data</span>.<span class="ruby-identifier">start</span>
                <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">block_given?</span>
                  <span class="ruby-keyword kw">yield</span>
                <span class="ruby-keyword kw">else</span>
                  <span class="ruby-identifier">perform_action_without_newrelic_trace</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>)
                <span class="ruby-keyword kw">end</span>
              <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Exception</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
                <span class="ruby-identifier">frame_data</span>.<span class="ruby-identifier">notice_error</span>(<span class="ruby-identifier">e</span>)
                <span class="ruby-identifier">raise</span>
              <span class="ruby-keyword kw">end</span>
            <span class="ruby-keyword kw">end</span>
          <span class="ruby-keyword kw">ensure</span>
            <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Agent</span><span class="ruby-operator">::</span><span class="ruby-constant">BusyCalculator</span>.<span class="ruby-identifier">dispatcher_finish</span>
            <span class="ruby-comment cmt"># Look for a metric frame in the thread local and process it.</span>
            <span class="ruby-comment cmt"># Clear the thread local when finished to ensure it only gets called once.</span>
            <span class="ruby-identifier">frame_data</span>.<span class="ruby-identifier">record_apdex</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">_is_filtered?</span>(<span class="ruby-value str">'ignore_apdex'</span>)

            <span class="ruby-identifier">frame_data</span>.<span class="ruby-identifier">pop</span>
          <span class="ruby-keyword kw">end</span>
        <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="sectiontitle">Instance Protected methods</div>
            
            <div class="method">
                <div class="title" id="M000951">
                    
                    <a name="M000951"></a><b>newrelic_request_headers</b>()
                    
                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000951_source')" id="l_M000951_source">show</a>
                        
                    </p>
                    <div id="M000951_source" class="dyn-source">
                        <pre><span class="ruby-comment cmt"># File lib/new_relic/agent/instrumentation/controller_instrumentation.rb, line 277</span>
        <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">newrelic_request_headers</span>
          <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-identifier">:request</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">request</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-identifier">:headers</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">request</span>.<span class="ruby-identifier">headers</span>
        <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
            <div class="method">
                <div class="title" id="M000950">
                    
                    <a name="M000950"></a><b>newrelic_response_code</b>()
                    
                </div>
                
                <div class="description">
                  <p>
Should be implemented in the dispatcher class
</p>

                </div>
                
                
                
                
                <div class="sourcecode">
                    <p class="source-link">
                        Source: <a href="javascript:toggleSource('M000950_source')" id="l_M000950_source">show</a>
                        
                    </p>
                    <div id="M000950_source" class="dyn-source">
                        <pre><span class="ruby-comment cmt"># File lib/new_relic/agent/instrumentation/controller_instrumentation.rb, line 275</span>
        <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">newrelic_response_code</span>; <span class="ruby-keyword kw">end</span></pre>
                    </div>
                </div>
                
            </div>
            
</div>
    </div>
  </body>
</html>    