<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Module: NewRelic::Agent::BusyCalculator</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href="../../.././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Module</strong></td>
          <td class="class-name-in-header">NewRelic::Agent::BusyCalculator</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../../../files/lib/new_relic/agent/busy_calculator_rb.html">
                lib/new_relic/agent/busy_calculator.rb
                </a>
        <br />
            </td>
        </tr>

        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">

    <div id="description">
      <p>
This module supports calculation of actual time spent processing requests
over the course of one harvest period. It&#8216;s similar to what you would
get if you just added up all the execution times of controller calls,
however that will be inaccurate when requests span the minute boundaries.
This module manages accounting of requests not yet completed.
</p>
<p>
Calls are re-entrant. All start calls must be paired with finish calls, or
a <a href="BusyCalculator.html#M000198">reset</a> call.
</p>

    </div>


   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000197">busy_count</a>&nbsp;&nbsp;
      <a href="#M000196">dispatcher_finish</a>&nbsp;&nbsp;
      <a href="#M000195">dispatcher_start</a>&nbsp;&nbsp;
      <a href="#M000199">harvest_busy</a>&nbsp;&nbsp;
      <a href="#M000198">reset</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->

    <div id="section">





    <div id="attribute-list">
      <h3 class="section-bar">Attributes</h3>

      <div class="name-list">
        <table>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">accumulator</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc">
For testability, add accessors:

</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">harvest_start</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc">
For testability, add accessors:

</td>
        </tr>
        </table>
      </div>
    </div>
      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M000197" class="method-detail">
        <a name="M000197"></a>

        <div class="method-heading">
          <a href="#M000197" class="method-signature">
          <span class="method-name">busy_count</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000197-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000197-source">
<pre>
<span class="ruby-comment cmt"># File lib/new_relic/agent/busy_calculator.rb, line 37</span>
  <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">busy_count</span>
    <span class="ruby-ivar">@entrypoint_stack</span>.<span class="ruby-identifier">size</span>
  <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000196" class="method-detail">
        <a name="M000196"></a>

        <div class="method-heading">
          <a href="#M000196" class="method-signature">
          <span class="method-name">dispatcher_finish</span><span class="method-args">(end_time = Time.now.to_f)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000196-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000196-source">
<pre>
<span class="ruby-comment cmt"># File lib/new_relic/agent/busy_calculator.rb, line 24</span>
  <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">dispatcher_finish</span>(<span class="ruby-identifier">end_time</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">to_f</span>)
    <span class="ruby-identifier">callers</span> = <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">current</span>[<span class="ruby-identifier">:busy_entries</span>] <span class="ruby-operator">-=</span> <span class="ruby-value">1</span>
    <span class="ruby-comment cmt"># Ignore nested calls</span>
    <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">callers</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
    <span class="ruby-ivar">@lock</span>.<span class="ruby-identifier">synchronize</span> <span class="ruby-keyword kw">do</span>
      <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@entrypoint_stack</span>.<span class="ruby-identifier">empty?</span>
        <span class="ruby-constant">NewRelic</span><span class="ruby-operator">::</span><span class="ruby-constant">Control</span>.<span class="ruby-identifier">instance</span>.<span class="ruby-identifier">log</span>.<span class="ruby-identifier">error</span>(<span class="ruby-node">&quot;Stack underflow tracking dispatcher entry and exit!\n  #{caller.join(&quot;  \n&quot;)}&quot;</span>) 
      <span class="ruby-keyword kw">else</span>
        <span class="ruby-ivar">@accumulator</span> <span class="ruby-operator">+=</span> (<span class="ruby-identifier">end_time</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@entrypoint_stack</span>.<span class="ruby-identifier">pop</span>)
      <span class="ruby-keyword kw">end</span>
    <span class="ruby-keyword kw">end</span>
  <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000195" class="method-detail">
        <a name="M000195"></a>

        <div class="method-heading">
          <a href="#M000195" class="method-signature">
          <span class="method-name">dispatcher_start</span><span class="method-args">(time)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000195-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000195-source">
<pre>
<span class="ruby-comment cmt"># File lib/new_relic/agent/busy_calculator.rb, line 15</span>
  <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">dispatcher_start</span>(<span class="ruby-identifier">time</span>)
    <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">current</span>[<span class="ruby-identifier">:busy_entries</span>] <span class="ruby-operator">||=</span> <span class="ruby-value">0</span> 
    <span class="ruby-identifier">callers</span> = <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">current</span>[<span class="ruby-identifier">:busy_entries</span>] <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
    <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">callers</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>
    <span class="ruby-ivar">@lock</span>.<span class="ruby-identifier">synchronize</span> <span class="ruby-keyword kw">do</span>
      <span class="ruby-ivar">@entrypoint_stack</span>.<span class="ruby-identifier">push</span> <span class="ruby-identifier">time</span>      
    <span class="ruby-keyword kw">end</span>
  <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000199" class="method-detail">
        <a name="M000199"></a>

        <div class="method-heading">
          <a href="#M000199" class="method-signature">
          <span class="method-name">harvest_busy</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Called before uploading to to the server to collect current busy stats.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000199-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000199-source">
<pre>
<span class="ruby-comment cmt"># File lib/new_relic/agent/busy_calculator.rb, line 54</span>
  <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">harvest_busy</span>
    <span class="ruby-identifier">busy</span> = <span class="ruby-value">0</span>
    <span class="ruby-identifier">t0</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">to_f</span>
    <span class="ruby-ivar">@lock</span>.<span class="ruby-identifier">synchronize</span> <span class="ruby-keyword kw">do</span>
      <span class="ruby-identifier">busy</span> = <span class="ruby-identifier">accumulator</span>
      <span class="ruby-ivar">@accumulator</span> = <span class="ruby-value">0</span>
      
      <span class="ruby-comment cmt"># Walk through the stack and capture all times up to </span>
      <span class="ruby-comment cmt"># now for entrypoints</span>
      <span class="ruby-ivar">@entrypoint_stack</span>.<span class="ruby-identifier">size</span>.<span class="ruby-identifier">times</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">frame</span><span class="ruby-operator">|</span> 
        <span class="ruby-identifier">busy</span> <span class="ruby-operator">+=</span> (<span class="ruby-identifier">t0</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@entrypoint_stack</span>[<span class="ruby-identifier">frame</span>])
        <span class="ruby-ivar">@entrypoint_stack</span>[<span class="ruby-identifier">frame</span>] = <span class="ruby-identifier">t0</span>
      <span class="ruby-keyword kw">end</span>
      
    <span class="ruby-keyword kw">end</span>
    
    <span class="ruby-identifier">busy</span> = <span class="ruby-value">0</span><span class="ruby-value">.0</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">busy</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">0</span><span class="ruby-value">.0</span> <span class="ruby-comment cmt"># don't go below 0%</span>
    
    <span class="ruby-identifier">time_window</span> = (<span class="ruby-identifier">t0</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">harvest_start</span>)
    <span class="ruby-identifier">time_window</span> = <span class="ruby-value">1.0</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">time_window</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span><span class="ruby-value">.0</span>  <span class="ruby-comment cmt"># protect against divide by zero</span>
    
    <span class="ruby-identifier">busy</span> = <span class="ruby-identifier">busy</span> <span class="ruby-operator">/</span> <span class="ruby-identifier">time_window</span>
    
    <span class="ruby-identifier">instance_busy_stats</span>.<span class="ruby-identifier">record_data_point</span> <span class="ruby-identifier">busy</span>
    <span class="ruby-ivar">@harvest_start</span> = <span class="ruby-identifier">t0</span>
  <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000198" class="method-detail">
        <a name="M000198"></a>

        <div class="method-heading">
          <a href="#M000198" class="method-signature">
          <span class="method-name">reset</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Reset the state of the information accumulated by all threads, but only <a
href="BusyCalculator.html#M000198">reset</a> the recursion counter for this
thread.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000198-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000198-source">
<pre>
<span class="ruby-comment cmt"># File lib/new_relic/agent/busy_calculator.rb, line 43</span>
  <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">reset</span>
    <span class="ruby-ivar">@entrypoint_stack</span> = []
    <span class="ruby-constant">Thread</span>.<span class="ruby-identifier">current</span>[<span class="ruby-identifier">:busy_entries</span>] = <span class="ruby-value">0</span>
    <span class="ruby-ivar">@lock</span> <span class="ruby-operator">||=</span> <span class="ruby-constant">Mutex</span>.<span class="ruby-identifier">new</span>
    <span class="ruby-ivar">@accumulator</span> = <span class="ruby-value">0</span>
    <span class="ruby-ivar">@harvest_start</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">to_f</span>
  <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>